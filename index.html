<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Sistema PyME ‚Äì Frutas & Verduras (Supabase)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --bg:#0f172a; --card:#111827; --muted:#334155; --text:#e5e7eb; --accent:#8b5cf6; --ok:#10b981; --warn:#f59e0b; --err:#ef4444; }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,#1e1b4b,#0b1020);font-family:Inter,system-ui,Arial;color:var(--text)}
    header{padding:16px;border-bottom:1px solid #26314e;background:radial-gradient(1000px 350px at 10% -20%,#2a2e78 0%,transparent 55%);display:flex;align-items:center;gap:12px}
    h1{margin:0;font-size:18px;font-weight:700}
    .sub{opacity:.8;font-size:12px;margin-left:6px}
    .wrap{max-width:1200px;margin:14px auto;padding:0 12px}
    .tabs{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0 16px;align-items:center}
    .tab{background:#1f2937;border:1px solid #334155;color:#cbd5e1;padding:8px 12px;border-radius:10px;cursor:pointer;display:none}
    .tab.active{border-color:#8b5cf6;color:white;box-shadow:0 0 0 2px #8b5cf633 inset}
    .config{margin-left:auto;background:#0b162d;border:1px solid #2b3a5a;color:#cbd5e1;padding:8px 12px;border-radius:10px;cursor:pointer;display:none}
    .card{background:#0b1222;border:1px solid #22304b;border-radius:14px;padding:14px;margin-bottom:16px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media(max-width:900px){.grid{grid-template-columns:1fr}}
    label{font-size:12px;opacity:.85;margin-bottom:4px;display:block}
    input,select{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #334155;background:#0b162d;color:#e5e7eb}
    button{border:0;border-radius:10px;padding:10px 14px;cursor:pointer}
    .primary{background:var(--accent);color:white} .ghost{background:#111827;color:#cbd5e1;border:1px solid #2b3a5a}
    .ok{background:var(--ok);color:#052e22} .warn{background:var(--warn);color:#190d00} .err{background:var(--err);color:#2a0909}
    table{width:100%;border-collapse:collapse;margin-top:10px;font-size:14px}
    th,td{padding:10px;border-bottom:1px solid #22304b} th{text-align:left;opacity:.8}
    .tag{font-size:12px;padding:2px 8px;border-radius:999px;border:1px solid #334155;background:#0b162d;display:inline-block}
    .right{display:flex;gap:8px;justify-content:flex-end}
    #toast{position:fixed;top:16px;right:16px;display:none;min-width:220px;max-width:360px;padding:12px 14px;border-radius:12px;background:#111827;border:1px solid #2b3a5a;color:#e5e7eb;box-shadow:0 8px 30px #0006;z-index:9999}
    .muted{opacity:.7}
    .num{width:120px}
    .kpis{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin:8px 0 4px}
    @media (max-width:900px){.kpis{grid-template-columns:1fr}}
    .kpi{background:#0b162d;border:1px solid #2b3a5a;border-radius:12px;padding:12px}
    .kpi .big{font-size:20px;font-weight:700}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
</head>
<body>
  <header id="appHeader" style="display:none">
    <h1>Sistema PyME ‚Äì Frutas & Verduras</h1>
    <div class="sub">Sesi√≥n: <span id="whoami"></span></div>
    <div class="right"><button class="ghost" id="btn-logout">Cerrar sesi√≥n</button></div>
  </header>

  <div id="toast"></div>

  <!-- ===== LOGIN ===== -->
  <div id="loginView" class="card">
    <h2>Ingresar</h2>
    <div class="grid">
      <div><label>Email</label><input id="lg-email" autocomplete="username" /></div>
      <div><label>Contrase√±a</label><input id="lg-pass" type="password" autocomplete="current-password" /></div>
    </div>
    <div class="right" style="margin-top:10px;gap:8px">
      <button class="primary" id="btn-login">Entrar</button>
    </div>
  </div>

  <!-- ===== APP ===== -->
  <div id="app" class="wrap" style="display:none">
    <div class="tabs" id="tabsBar">
      <button class="tab" data-tab="pedidos">üßæ Pedidos</button>
      <button class="tab" data-tab="stock">üì¶ Stock</button>
      <button class="tab" data-tab="envases">üß¥ Envases</button>
      <button class="tab" data-tab="produccion">üè≠ Producci√≥n</button>
      <button class="tab" data-tab="resumen">üìÑ Resumen</button>
      <button class="tab" data-tab="pendientes">üìä Pendientes</button>
      <button class="tab" data-tab="historial">üìë Historial (insumos)</button>
      <button class="tab" data-tab="historial-env">üß¥ Historial envases</button>
      <button class="config" id="btn-config">‚öô Configuraci√≥n</button>
    </div>

    <!-- ===== PEDIDOS ===== -->
    <section class="card" id="tab-pedidos" style="display:none">
      <h2>Registrar pedido</h2>
      <div class="grid">
        <div><label>Fecha</label><input type="date" id="p-fecha" /></div>
        <div><label>Proveedor</label><input id="p-proveedor" /></div>
        <div><label>C√≥digo</label><input id="p-codigo" placeholder="ZAN-001 o PROD-001" /></div>
        <div><label>Descripci√≥n (se autocompleta)</label><input id="p-descripcion" /></div>
        <div><label>Cantidad pedida</label><input id="p-cant" class="num" type="number" min="0" step="0.01" /></div>
        <div><label>Unidad</label><select id="p-unidad"><option>kg</option><option>unid</option><option>bandejas</option><option>paquetes</option></select></div>
        <div><label>Precio unitario</label><input id="p-precio" class="num" type="number" min="0" step="0.01" /></div>
        <div><label>Estado</label><select id="p-estado"><option>Pendiente</option><option>Entregado</option><option>Cancelado</option></select></div>
        <!-- Campos nuevos -->
        <div><label>Cantidad Bulto</label><input id="p-bulto" class="num" type="number" min="0" step="0.01" /></div>
        <div><label>Calidad</label><input id="p-calidad" /></div>
        <div><label>Envase (c√≥digo)</label><input id="p-envase" placeholder="CAJA-1KG" /></div>
        <div><label>Kg</label><input id="p-kg" class="num" type="number" min="0" step="0.01" /></div>
        <div><label>Respa</label><input id="p-respa" /></div>
      </div>
      <div class="right" style="margin-top:10px">
        <button class="ghost" id="p-limpiar">Limpiar</button>
        <button class="primary" id="p-crear">Crear pedido</button>
      </div>
      <table id="tbl-pedidos"><thead><tr>
        <th>Fecha</th><th>C√≥digo</th><th>Descripci√≥n</th><th>Prov.</th>
        <th>Pedida</th><th>Recibido</th><th>Unidad</th><th>Precio</th>
        <th>Cant. Bulto</th><th>Calidad</th><th>Envase</th><th>Kg</th><th>Respa</th>
        <th>Estado</th><th></th>
      </tr></thead><tbody></tbody></table>
    </section>

    <!-- ===== STOCK ===== -->
    <section class="card" id="tab-stock" style="display:none">
      <h2>Stock de insumos</h2>
      <div class="right" style="margin-bottom:8px"><button class="err" id="btn-reset-stock">Reset a 0</button></div>
      <table id="tbl-stock"><thead><tr>
        <th>C√≥digo</th><th>Descripci√≥n</th><th>Stock</th><th>Unidad</th><th>Pto. Repo</th><th>Alerta</th>
      </tr></thead><tbody></tbody></table>
    </section>

    <!-- ===== ENVASES ===== -->
    <section class="card" id="tab-envases" style="display:none">
      <h2>Stock de envases</h2>
      <div class="grid">
        <div><label>C√≥digo</label><input id="ev-codigo" /></div>
        <div><label>Descripci√≥n</label><input id="ev-descripcion" /></div>
        <div><label>Unidad</label><input id="ev-unidad" placeholder="caja / bolsa / pack" /></div>
      </div>
      <div class="right" style="margin-top:10px"><button class="primary" id="ev-agregar">Agregar/Actualizar envase</button></div>

      <h3 style="margin-top:16px">Movimientos manuales</h3>
      <div class="grid">
        <div><label>Envase (c√≥digo)</label><input id="evm-codigo" /></div>
        <div><label>Cantidad</label><input id="evm-cant" type="number" min="0" step="0.01" /></div>
        <div><label>Movimiento</label>
          <select id="evm-tipo"><option value="ENTRADA">Entrada</option><option value="SALIDA">Salida</option></select>
        </div>
        <div><label>Motivo</label><input id="evm-motivo" placeholder="Ajuste manual / compra directa / merma, etc." /></div>
      </div>
      <div class="right" style="margin-top:10px;gap:8px">
        <button class="ghost" id="btn-reset-envases">Reset a 0</button>
        <button class="primary" id="evm-registrar">Registrar movimiento</button>
      </div>

      <table id="tbl-envases" style="margin-top:12px">
        <thead><tr><th>C√≥digo</th><th>Descripci√≥n</th><th>Stock</th><th>Unidad</th><th>Pto. Repo</th><th>Alerta</th></tr></thead>
        <tbody></tbody>
      </table>
    </section>

    <!-- ===== PRODUCCI√ìN ===== -->
    <section class="card" id="tab-produccion" style="display:none">
      <h2>Orden de producci√≥n</h2>
      <div class="grid">
        <div><label>Fecha</label><input type="date" id="pr-fecha" /></div>
        <div><label>Producto final (c√≥digo o desc.)</label><input id="pr-desc" /></div>
        <div><label>Cliente</label><input id="pr-cliente" /></div>
        <div><label>Cantidad</label><input id="pr-cant" type="number" min="0" step="0.01" /></div>
        <div><label>Unidad</label><select id="pr-unidad"><option>bandejas</option><option>kg</option><option>paquetes</option><option>unid</option></select></div>
        <div><label>Envase (c√≥digo)</label><input id="pr-envase" /></div>
        <div><label>INSUMO (c√≥digo)</label><input id="pr-insumo" placeholder="ZAN-001" /></div>
        <div><label>Consumo insumo</label><input id="pr-insumo-cant" type="number" min="0" step="0.01" /></div>
        <div><label>Estado</label><select id="pr-estado"><option>En proceso</option><option>Terminado</option></select></div>
        <div style="grid-column:1/-1"><label>Observaciones</label><input id="pr-obs" /></div>
        <!-- Nuevos datos -->
        <div><label>Cantidad Bulto (envase)</label><input id="pr-bulto" type="number" min="0" step="0.01" /></div>
        <div><label>Calidad</label><input id="pr-calidad" /></div>
        <div><label>Kg</label><input id="pr-kg" type="number" min="0" step="0.01" /></div>
        <div><label>Respa</label><input id="pr-respa" /></div>
      </div>
      <div class="right" style="margin-top:10px"><button class="primary" id="pr-crear">Crear orden</button></div>
      <table id="tbl-prod"><thead><tr>
        <th>Fecha</th><th>Cliente</th><th>Producto</th><th>Cant</th><th>Unidad</th><th>Envase</th><th>Insumo</th><th>Consumo</th>
        <th>Bulto</th><th>Calidad</th><th>Kg</th><th>Respa</th><th>Estado</th><th></th>
      </tr></thead><tbody></tbody></table>
    </section>

    <!-- ===== RESUMEN ===== -->
    <section class="card" id="tab-resumen" style="display:none">
      <h2>√ìrdenes finalizadas (para Remito)</h2>
      <div class="grid">
        <div><label>Cliente (contiene)</label><input id="f-cli" /></div>
        <div><label>Desde</label><input type="date" id="f-desde" /></div>
        <div><label>Hasta</label><input type="date" id="f-hasta" /></div>
      </div>
      <div class="right" style="margin-top:10px;gap:8px">
        <button class="ghost" id="f-limpiar">Limpiar</button>
        <button class="primary" id="btn-print">Imprimir Remito</button>
      </div>
      <table id="tbl-resumen"><thead><tr>
        <th>Fecha</th><th>Cliente</th><th>Producto</th><th>Cant</th><th>Unidad</th><th>Envase</th><th>Precio Total</th>
        <th>Bulto</th><th>Calidad</th><th>Kg</th><th>Respa</th><th>Obs</th>
      </tr></thead><tbody></tbody></table>
      <div class="right" style="margin-top:6px">Total: $ <b id="res-total">0.00</b></div>
    </section>

    <!-- ===== PENDIENTES ===== -->
    <section class="card" id="tab-pendientes" style="display:none">
      <h2>Pedidos pendientes (Compras)</h2>
      <div class="kpis">
        <div class="kpi"><div class="muted">√ìrdenes pendientes</div><div class="big" id="pp-kpi-pend">0</div></div>
        <div class="kpi"><div class="muted">Monto estimado</div><div class="big">$ <span id="pp-kpi-monto">0.00</span></div></div>
        <div class="kpi"><div class="muted">Proveedores activos</div><div class="big" id="pp-kpi-prov">0</div></div>
      </div>
      <div class="grid">
        <div><label>Proveedor (contiene)</label><input id="pp-prov" /></div>
        <div><label>Desde</label><input type="date" id="pp-desde" /></div>
        <div><label>Hasta</label><input type="date" id="pp-hasta" /></div>
      </div>
      <div class="right" style="margin-top:10px;gap:8px">
        <button class="ghost" id="pp-limpiar">Limpiar filtros</button>
        <button class="primary" id="pp-print">Imprimir</button>
      </div>
      <table id="tbl-pendientes"><thead><tr>
        <th>Fecha</th><th>Proveedor</th><th>C√≥digo</th><th>Descripci√≥n</th>
        <th>Pedida</th><th>Recibido</th><th>Pendiente</th><th>Unidad</th><th>Precio</th><th>Subtotal</th>
        <th>Bulto</th><th>Calidad</th><th>Envase</th><th>Kg</th><th>Respa</th><th>Acciones</th>
      </tr></thead><tbody></tbody></table>
    </section>

    <!-- ===== HISTORIAL INSUMOS ===== -->
    <section class="card" id="tab-historial" style="display:none">
      <h2>Historial de movimientos (insumos)</h2>
      <table id="tbl-historial"><thead><tr>
        <th>Fecha</th><th>C√≥digo</th><th>Descripci√≥n</th><th class="right">Œî</th><th>Unidad</th><th>Motivo</th>
      </tr></thead><tbody></tbody></table>
    </section>

    <!-- ===== HISTORIAL ENVASES ===== -->
    <section class="card" id="tab-historial-env" style="display:none">
      <h2>Historial de movimientos de envases</h2>
      <table id="tbl-hist-env"><thead><tr>
        <th>Fecha</th><th>C√≥digo</th><th>Descripci√≥n</th><th class="right">Œî</th><th>Unidad</th><th>Motivo</th>
      </tr></thead><tbody></tbody></table>
    </section>
  </div>

  <script>
  /* ===== SUPABASE ===== */
  const SUPABASE_URL = "TU_SUPABASE_URL";
  const SUPABASE_ANON_KEY = "TU_SUPABASE_ANON_KEY";
  const { createClient } = window.supabase;
  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  /* ===== Estado / helpers ===== */
  const cache = { org:null, profile:null, perms:[], products:[], stock:{}, pedidos:[], prod:[], resumen:[], hist:[], envases:[], envHist:[] };
  const $ = id=>document.getElementById(id);
  const fmt2 = n => (isFinite(n)?Number(n).toFixed(2):'');
  function toast(m){ const t=$('toast'); t.style.display='block'; t.textContent=m; setTimeout(()=>t.style.display='none',2200); }
  function escapeHtml(s){ if(s==null) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
  const can = _ => true; // simplificado: mostrar todas las pesta√±as

  /* ===== Auth m√≠nimo ===== */
  $('btn-login').onclick = async ()=>{
    const email=$('lg-email').value.trim(), pass=$('lg-pass').value;
    if(!email||!pass){ toast('Complet√° email y contrase√±a'); return; }
    const { data, error } = await supabase.auth.signInWithPassword({ email, password:pass });
    if(error){ toast(error.message); return; }
    await afterAuth(data.user);
  };
  $('btn-logout').onclick = async ()=>{ await supabase.auth.signOut(); showLogin(); };
  supabase.auth.onAuthStateChange(async (ev, session)=>{
    if(ev==='SIGNED_IN' && session?.user){ await afterAuth(session.user); }
    if(ev==='SIGNED_OUT'){ showLogin(); }
  });
  function showLogin(){ $('appHeader').style.display='none'; $('app').style.display='none'; $('loginView').style.display='block'; }
  function showApp(){ $('loginView').style.display='none'; $('appHeader').style.display='flex'; $('app').style.display='block'; }

  async function afterAuth(user){
    const { data:profile } = await supabase.from('profiles').select('*').eq('user_id', user.id).maybeSingle();
    cache.profile = profile || { name:user.email, org_id:null };
    cache.org = { id: profile?.org_id || null };
    $('whoami').textContent = user.email;
    showApp();
    document.querySelectorAll('.tab').forEach(b=> b.style.display='inline-block');
    const first = document.querySelector('.tab'); if(first) activateTab(first.dataset.tab);
    await loadAll(); renderAll();
  }

  /* ===== Carga de datos ===== */
  async function loadAll(){
    const org=cache.org.id;
    const [prodRes, stockRes, pedRes, opRes, resRes, histRes, envRes, envHistRes] = await Promise.all([
      supabase.from('products').select('*').eq('org_id',org),
      supabase.from('stock').select('*').eq('org_id',org),
      supabase.from('pedidos').select('*').eq('org_id',org).order('created_at',{ascending:false}),
      supabase.from('produccion').select('*').eq('org_id',org).order('created_at',{ascending:false}),
      supabase.from('resumen').select('*').eq('org_id',org).order('created_at',{ascending:false}),
      supabase.from('historial_stock').select('*').eq('org_id',org).order('fecha',{ascending:false}),
      supabase.from('envases').select('*').eq('org_id',org),
      supabase.from('envases_historial').select('*').eq('org_id',org).order('fecha',{ascending:false})
    ].map(p=>p.catch(()=>({data:[]})))); // tolerante

    cache.products = prodRes.data||[];
    cache.stock    = Object.fromEntries((stockRes.data||[]).map(s=>[s.codigo,s]));
    cache.pedidos  = pedRes.data||[];
    cache.prod     = opRes.data||[];
    cache.resumen  = resRes.data||[];
    cache.hist     = histRes.data||[];
    cache.envases  = envRes.data||[];
    cache.envHist  = envHistRes.data||[];
  }

  function renderAll(){
    renderProductos(); renderEnvasesConf(); renderStock(); renderEnvasesStock();
    renderPedidos(); renderProduccion(); renderResumen(); renderPendientes(); renderHistorial(); renderHistorialEnv();
  }

  /* ===== Productos (solo helpers UI) ===== */
  function prodByCode(c){ return cache.products.find(p=>(p.codigo||'').toLowerCase()===String(c||'').toLowerCase()); }
  function prodByAny(v){ const s=String(v||'').toLowerCase(); return cache.products.find(p => (p.codigo||'').toLowerCase()===s || (p.descripcion||'').toLowerCase()===s); }

  /* ===== Stock insumos ===== */
  async function sbUpsertStock({codigo,descripcion,unidad,delta,motivo}){
    const org=cache.org.id; const row=cache.stock[codigo];
    if(row){
      const newQty = (Number(row.qty)||0) + Number(delta||0);
      const { error } = await supabase.from('stock').update({ qty:newQty, descripcion: row.descripcion||descripcion, unidad: row.unidad||unidad }).eq('id',row.id);
      if(error) throw error; cache.stock[codigo].qty=newQty;
    }else{
      const { data, error } = await supabase.from('stock').insert({ org_id:org, codigo, descripcion, unidad, qty:Number(delta||0) }).select().single();
      if(error) throw error; cache.stock[codigo]=data;
    }
    try{
      await supabase.from('historial_stock').insert({ org_id:org, codigo, descripcion, delta, unidad, motivo: motivo||'' });
    }catch(_){/* tolerante */}
  }

  async function sbConsumeStock(codigo,qty,motivo){
    const row=cache.stock[codigo]; if(!row) return false;
    if((Number(row.qty)||0) < (Number(qty)||0)) return false;
    await sbUpsertStock({codigo, descripcion:row.descripcion, unidad:row.unidad, delta:-Number(qty), motivo});
    return true;
  }

  function setRepo(codigo){ return async (val)=>{
    const row=cache.stock[codigo]; if(!row) return;
    const { error } = await supabase.from('stock').update({ repo: Number(val)||0 }).eq('id',row.id);
    if(error) return toast(error.message);
    cache.stock[codigo].repo = Number(val)||0;
  }; }

  function renderStock(){
    const tbody=document.querySelector('#tbl-stock tbody');
    const rows = Object.entries(cache.stock).map(([c,s])=>{
      const alert = (s.repo && (Number(s.qty)||0)<=s.repo) ? '‚ö†Ô∏è Bajo' : '';
      return `<tr><td>${c}</td><td>${s.descripcion||''}</td><td>${fmt2(+s.qty||0)}</td><td>${s.unidad||''}</td>
        <td><input type="number" min="0" step="0.01" value="${s.repo||0}" style="width:110px" oninput="(${setRepo.toString()})('${c}')(this.value)"></td>
        <td>${alert}</td></tr>`;
    }).join('');
    tbody.innerHTML = rows || `<tr><td colspan="6" class="muted">Sin insumos</td></tr>`;
  }
  function renderHistorial(){
    const tbody=document.querySelector('#tbl-historial tbody');
    tbody.innerHTML = (cache.hist||[]).map(h=>`
      <tr><td>${new Date(h.fecha).toLocaleString()}</td><td>${h.codigo||''}</td><td>${h.descripcion||''}</td>
      <td class="right">${h.delta>0?'+':''}${fmt2(h.delta)}</td><td>${h.unidad||''}</td><td>${h.motivo||''}</td></tr>
    `).join('') || `<tr><td colspan="6" class="muted">Sin movimientos</td></tr>`;
  }

  /* ===== Envases: stock + historial + ajustes ===== */
  async function sbAdjustEnvaseStock(codigo, delta, motivo){
    const org=cache.org.id;
    let row = cache.envases.find(e => (e.codigo||'').toLowerCase() === String(codigo||'').toLowerCase());
    if(!row){
      const { data, error } = await supabase.from('envases').insert({ org_id:org, codigo, descripcion:'', unidad:'', stock:0, repo:0 }).select().single();
      if(error) throw error;
      row = data; cache.envases.push(row);
    }
    const nuevo = Number(row.stock||0) + Number(delta||0);
    const { error: e1 } = await supabase.from('envases').update({ stock: nuevo }).eq('id', row.id);
    if(e1) throw e1;
    row.stock = nuevo;

    try{
      await supabase.from('envases_historial').insert({
        org_id: org,
        codigo: row.codigo,
        descripcion: row.descripcion || '',
        delta: Number(delta||0),
        unidad: row.unidad || '',
        motivo: motivo || ''
      });
    }catch(_){/* tolerante si no existe tabla o RLS */}
    try{
      const { data } = await supabase.from('envases_historial').select('*').eq('org_id',org).order('fecha',{ascending:false});
      cache.envHist = data||cache.envHist;
    }catch(_){}
    return { ok:true, stock:nuevo };
  }

  function setRepoEnvase(codigo){ return async (val)=>{
    const row=cache.envases.find(e=>e.codigo===codigo); if(!row) return;
    const { error } = await supabase.from('envases').update({ repo:Number(val)||0 }).eq('id',row.id);
    if(error) return toast(error.message);
    row.repo=Number(val)||0;
  }; }

  $('ev-agregar').onclick = async ()=>{
    const codigo=($('ev-codigo').value||'').trim(); if(!codigo) return toast('C√≥digo requerido');
    const descripcion=$('ev-descripcion').value||''; const unidad=$('ev-unidad').value||'';
    const org=cache.org.id;
    const { data:exist } = await supabase.from('envases').select('id').eq('org_id',org).eq('codigo',codigo).maybeSingle();
    if(exist) await supabase.from('envases').update({ descripcion, unidad }).eq('id',exist.id);
    else await supabase.from('envases').insert({ org_id:org, codigo, descripcion, unidad, stock:0, repo:0 });
    await loadAll(); renderEnvasesStock(); toast('Envase guardado');
    ['ev-codigo','ev-descripcion','ev-unidad'].forEach(i=>$(i).value='');
  };

  $('btn-reset-envases').onclick = async ()=>{
    const org=cache.org.id;
    try{
      for(const e of cache.envases){
        if(Number(e.stock||0)!==0){
          await sbAdjustEnvaseStock(e.codigo, -Number(e.stock||0), 'Reset a 0');
        }
      }
      await loadAll(); renderEnvasesStock(); renderHistorialEnv();
      toast('Stock de envases reiniciado');
    }catch(err){ toast('Error: '+err.message); }
  };

  $('evm-registrar').onclick = async ()=>{
    const codigo=($('evm-codigo').value||'').trim(); const cant=+($('evm-cant').value||0);
    const tipo=$('evm-tipo').value; const motivo=$('evm-motivo').value||'Ajuste manual';
    if(!codigo||cant<=0) return toast('C√≥digo y cantidad');
    const delta = (tipo==='ENTRADA')? +cant : -cant;
    try{
      await sbAdjustEnvaseStock(codigo, delta, motivo);
      await loadAll(); renderEnvasesStock(); renderHistorialEnv();
      toast('Movimiento registrado');
      ['evm-codigo','evm-cant','evm-motivo'].forEach(i=>$(i).value='');
    }catch(err){ toast('Error: '+err.message); }
  };

  function renderEnvasesStock(){
    const tbody=document.querySelector('#tbl-envases tbody');
    const rows = cache.envases.map(e=>{
      const alert = (e.repo && (Number(e.stock)||0)<=e.repo) ? '‚ö†Ô∏è Bajo' : '';
      return `<tr>
        <td>${e.codigo}</td><td>${escapeHtml(e.descripcion||'')}</td><td>${fmt2(+e.stock||0)}</td><td>${e.unidad||''}</td>
        <td><input type="number" min="0" step="0.01" value="${e.repo||0}" style="width:110px" oninput="(${setRepoEnvase.toString()})('${e.codigo}')(this.value)"></td>
        <td>${alert}</td>
      </tr>`;
    }).join('');
    tbody.innerHTML = rows || `<tr><td colspan="6" class="muted">Sin envases</td></tr>`;
  }
  function renderHistorialEnv(){
    const tbody=document.querySelector('#tbl-hist-env tbody');
    tbody.innerHTML = (cache.envHist||[]).map(h=>`
      <tr><td>${new Date(h.fecha).toLocaleString()}</td><td>${h.codigo||''}</td><td>${h.descripcion||''}</td>
      <td class="right">${h.delta>0?'+':''}${fmt2(h.delta)}</td><td>${h.unidad||''}</td><td>${h.motivo||''}</td></tr>
    `).join('') || `<tr><td colspan="6" class="muted">Sin movimientos</td></tr>`;
  }

  /* ===== Pedidos ===== */
  $('p-codigo').addEventListener('blur', ()=>{
    const p=prodByCode(($('p-codigo').value||'').trim().toLowerCase());
    if(p){
      $('p-descripcion').value=p.descripcion||$('p-descripcion').value;
      $('p-unidad').value=p.unidad||$('p-unidad').value;
      if(p.envase && !$('p-envase').value) $('p-envase').value = p.envase;
    }
  });

  $('p-crear').onclick = async ()=>{
    const p = {
      fecha: $('p-fecha').value || new Date().toISOString().slice(0,10),
      prov: $('p-proveedor').value.trim(),
      codigo: $('p-codigo').value.trim(),
      descripcion: $('p-descripcion').value.trim(),
      cant: parseFloat($('p-cant').value||0),
      recibido: null, recibido_aplicado: 0,
      unidad: $('p-unidad').value, precio: parseFloat($('p-precio').value||0),
      estado: $('p-estado').value,
      bulto: parseFloat($('p-bulto').value||0),
      calidad: $('p-calidad').value.trim(),
      envase: $('p-envase').value.trim(),
      kg: parseFloat($('p-kg').value||0),
      respa: $('p-respa').value.trim()
    };
    if(!p.codigo || !p.cant) return toast('C√≥digo y cantidad');

    const prod=prodByCode(p.codigo);
    if(prod){ if(!p.descripcion) p.descripcion=prod.descripcion; if(!p.unidad) p.unidad=prod.unidad; if(!p.envase && prod.envase) p.envase=prod.envase; }

    const org=cache.org.id;
    const { data: row, error: eIns } = await supabase.from('pedidos').insert({ org_id:org, ...p }).select().single();
    if(eIns) return toast(eIns.message);

    // *** Entrada de envases al crear Pedido ***
    let aplicado = 0;
    const envValido = p.envase && cache.envases.some(e => (e.codigo||'').toLowerCase() === p.envase.toLowerCase());
    if (envValido && Number(p.bulto||0) > 0){
      try{
        await sbAdjustEnvaseStock(p.envase, +Number(p.bulto), `Entrada por Pedido ${row.id}`);
        aplicado = Number(p.bulto);
      }catch(err){ console.error(err); toast('No se pudo sumar stock de envases'); }
    }
    if(aplicado>0){
      try{ await supabase.from('pedidos').update({ bulto_aplicado_envase: aplicado }).eq('id',row.id); }catch(_){}
    }

    if(p.estado==='Entregado'){
      const rec = (p.recibido!=null)?p.recibido:p.cant;
      await sbUpsertStock({ codigo:p.codigo, descripcion:p.descripcion, unidad:p.unidad, delta:rec, motivo:`Recepci√≥n pedido ${row.id}` });
      await supabase.from('pedidos').update({ recibido_aplicado: rec }).eq('id',row.id);
    }

    await loadAll(); renderPedidos(); renderStock(); renderPendientes(); renderEnvasesStock(); renderHistorialEnv();
    toast('Pedido creado');
  };

  $('p-limpiar').onclick = ()=>{ ['p-fecha','p-codigo','p-descripcion','p-proveedor','p-cant','p-precio','p-bulto','p-calidad','p-envase','p-kg','p-respa'].forEach(i=>$(i).value=''); $('p-estado').value='Pendiente'; };

  function setPedidoRecibido(id){ return async (val)=>{
    const rec = (val===''?null:Math.max(0,parseFloat(val||0)));
    const { error } = await supabase.from('pedidos').update({ recibido: rec }).eq('id',id);
    if(error) return toast(error.message);
    await loadAll(); renderPedidos(); renderPendientes();
  }; }

  async function markPedidoEntregado(id){
    const { data:p } = await supabase.from('pedidos').select('*').eq('id',id).maybeSingle();
    if(!p) return;
    const recTarget = (p.recibido!=null? p.recibido : p.cant);
    const diff = recTarget - (p.recibido_aplicado||0);
    if(Math.abs(diff)>0){
      await sbUpsertStock({ codigo:p.codigo, descripcion:p.descripcion||'', unidad:p.unidad||'', delta:diff, motivo:`Recepci√≥n pedido ${id}` });
    }
    await supabase.from('pedidos').update({ estado:'Entregado', recibido_aplicado: recTarget }).eq('id',id);
    await loadAll(); renderPedidos(); renderStock(); renderPendientes(); renderHistorial();
    toast('Entregado');
  }

  function delPedido(id){ return async ()=>{
    const p = cache.pedidos.find(x=>x.id===id); if(!p) return;

    if (p.recibido_aplicado){
      await sbUpsertStock({ codigo:p.codigo, descripcion:p.descripcion||'', unidad:p.unidad||'', delta:-p.recibido_aplicado, motivo:`Reverso recepci√≥n ${id}` });
    }

    // *** Reversa de envases: restar lo que se hab√≠a sumado ***
    const bAplic = Number(p.bulto_aplicado_envase||0);
    if (p.envase && bAplic>0){
      try{ await sbAdjustEnvaseStock(p.envase, -bAplic, `Reversa entrada envase Pedido ${id}`); }catch(err){ console.error(err); }
    }

    await supabase.from('pedidos').delete().eq('id',id);
    await loadAll(); renderPedidos(); renderStock(); renderPendientes(); renderEnvasesStock(); renderHistorialEnv();
    toast('Pedido borrado');
  }; }

  function renderPedidos(){
    const tbody=document.querySelector('#tbl-pedidos tbody');
    tbody.innerHTML = cache.pedidos.map(p=>`
      <tr>
        <td>${p.fecha}</td><td>${p.codigo}</td><td>${escapeHtml(p.descripcion||'-')}</td><td>${p.prov||'-'}</td>
        <td>${p.cant}</td>
        <td><input type="number" class="num" min="0" step="0.01" value="${p.recibido??''}" placeholder="${p.cant}" oninput="(${setPedidoRecibido.toString()})('${p.id}')(this.value)"></td>
        <td>${p.unidad||'-'}</td><td>${p.precio!=null?fmt2(p.precio):'-'}</td>
        <td>${p.bulto!=null?fmt2(p.bulto):'-'}</td>
        <td>${escapeHtml(p.calidad||'-')}</td>
        <td>${escapeHtml(p.envase||'-')}</td>
        <td>${p.kg!=null?fmt2(p.kg):'-'}</td>
        <td>${escapeHtml(p.respa||'-')}</td>
        <td><span class="tag">${p.estado}</span></td>
        <td class="right">
          <button class="ok" onclick="markPedidoEntregado('${p.id}')">Entregado</button>
          <button class="ghost" onclick="(${delPedido.toString()})('${p.id}')()">Borrar</button>
        </td>
      </tr>
    `).join('') || `<tr><td colspan="15" class="muted">Sin pedidos</td></tr>`;
  }

  /* ===== Producci√≥n ===== */
  $('pr-desc').addEventListener('blur', ()=>{
    const p=prodByAny(($('pr-desc').value||'').trim());
    if(p){ $('pr-unidad').value=p.unidad||$('pr-unidad').value; if(p.envase && !$('pr-envase').value) $('pr-envase').value=p.envase; if(String(p.codigo).toLowerCase()===String($('pr-desc').value).toLowerCase()) $('pr-desc').value=p.descripcion; }
  });

  $('pr-crear').onclick = async ()=>{
    const o = {
      fecha:$('pr-fecha').value||new Date().toISOString().slice(0,10),
      cliente:$('pr-cliente').value.trim(),
      codigo_prod:null, prod_nombre:$('pr-desc').value.trim(),
      cant:parseFloat($('pr-cant').value||0),
      unidad:$('pr-unidad').value, envase:($('pr-envase').value||'').trim(),
      ins:$('pr-insumo').value.trim(), ins_cant:parseFloat($('pr-insumo-cant').value||0),
      estado:$('pr-estado').value, obs:$('pr-obs').value.trim(),
      bulto: parseFloat($('pr-bulto').value||0),
      calidad: $('pr-calidad').value.trim(),
      kg: parseFloat($('pr-kg').value||0),
      respa: $('pr-respa').value.trim()
    };
    if(!o.prod_nombre||!o.cant||!o.ins||!o.ins_cant) return toast('Completar producto/cant/insumo');

    const pm = prodByAny(o.prod_nombre); if(pm){ o.codigo_prod=pm.codigo; o.prod_nombre=pm.descripcion; o.unidad=o.unidad||pm.unidad; o.envase=o.envase||pm.envase; }

    const row=cache.stock[o.ins]; if(!row || (Number(row.qty)||0) < Number(o.ins_cant||0)) return toast('Stock de insumo insuficiente');

    await sbConsumeStock(o.ins, o.ins_cant, 'Consumo producci√≥n');

    const org=cache.org.id;
    const { data:insOP, error } = await supabase.from('produccion').insert({ org_id:org, ...o, consumo_aplicado:o.ins_cant }).select().single();
    if(error) return toast(error.message);

    // *** Salida de envases al crear Producci√≥n ***
    let envAplic = 0;
    const envValido = o.envase && cache.envases.some(e => (e.codigo||'').toLowerCase() === o.envase.toLowerCase());
    if (envValido && Number(o.bulto||0) > 0){
      try{
        await sbAdjustEnvaseStock(o.envase, -Number(o.bulto), `Salida por Producci√≥n ${insOP.id}`);
        envAplic = Number(o.bulto);
      }catch(err){ console.error(err); toast('No se pudo descontar envases'); }
    }
    if(envAplic>0){ try{ await supabase.from('produccion').update({ bulto_envase_aplicado: envAplic }).eq('id',insOP.id); }catch(_){} }

    if(o.estado==='Terminado') await upsertResumenFromOP({ ...insOP, bulto:o.bulto, calidad:o.calidad, kg:o.kg, respa:o.respa });

    await loadAll(); renderProduccion(); renderStock(); renderHistorial(); renderEnvasesStock(); renderHistorialEnv(); renderResumen();
    toast('Orden creada');
  };

  async function upsertResumenFromOP(o){
    const org=cache.org.id;
    const prodNombre = o.prod_nombre || (o.codigo_prod ? (cache.products.find(p=>p.codigo===o.codigo_prod)?.descripcion || '') : '');
    const payload = {
      org_id:org, id_op:o.id, fecha:o.fecha, cliente:o.cliente, prod_nombre:prodNombre, codigo_prod:o.codigo_prod||null,
      cant:o.cant, unidad:o.unidad, envase:o.envase, obs:o.obs,
      bulto: o.bulto ?? null, calidad: o.calidad ?? null, kg: o.kg ?? null, respa: o.respa ?? null
    };
    const { data:exists } = await supabase.from('resumen').select('id').eq('org_id',org).eq('id_op',o.id).maybeSingle();
    if(exists) await supabase.from('resumen').update(payload).eq('id',exists.id);
    else await supabase.from('resumen').insert(payload);
  }

  async function markOPTerminado(id){
    const { data:o } = await supabase.from('produccion').select('*').eq('id',id).maybeSingle();
    if(!o) return; if(o.estado==='Terminado') return toast('Ya terminada');
    await supabase.from('produccion').update({ estado:'Terminado' }).eq('id',id);
    await upsertResumenFromOP(o); await loadAll(); renderProduccion(); renderResumen(); toast('Orden migrada');
  }

  function delOP(id){ return async ()=>{
    const o=cache.prod.find(x=>x.id===id); if(!o) return;

    if(o.consumo_aplicado){
      await sbUpsertStock({ codigo:o.ins, descripcion:cache.stock[o.ins]?.descripcion||'', unidad:cache.stock[o.ins]?.unidad||'', delta:o.consumo_aplicado, motivo:`Reverso consumo ${id}` });
    }
    const bEnv = Number(o.bulto_envase_aplicado||0);
    if (o.envase && bEnv>0){
      try{ await sbAdjustEnvaseStock(o.envase, +bEnv, `Reversa salida envase OP ${id}`);}catch(err){ console.error(err); }
    }

    await supabase.from('produccion').delete().eq('id',id);
    await supabase.from('resumen').delete().eq('id_op',id);
    await loadAll(); renderProduccion(); renderResumen(); renderStock(); renderHistorial(); renderEnvasesStock(); renderHistorialEnv();
    toast('Orden borrada');
  }; }

  function renderProduccion(){
    const tbody=document.querySelector('#tbl-prod tbody');
    const rows = cache.prod.map(o=>`
      <tr>
        <td>${o.fecha}</td><td>${escapeHtml(o.cliente||'-')}</td>
        <td>${escapeHtml(o.prod_nombre||'')}${o.codigo_prod?` <span class="muted">(${o.codigo_prod})</span>`:''}</td>
        <td>${o.cant}</td><td>${o.unidad||''}</td><td>${o.envase||''}</td>
        <td>${o.ins}</td><td>${o.ins_cant}</td>
        <td>${o.bulto!=null?fmt2(o.bulto):'-'}</td>
        <td>${escapeHtml(o.calidad||'-')}</td>
        <td>${o.kg!=null?fmt2(o.kg):'-'}</td>
        <td>${escapeHtml(o.respa||'-')}</td>
        <td><span class="tag">${o.estado}</span></td>
        <td class="right">
          <button class="ok" onclick="markOPTerminado('${o.id}')">Terminar</button>
          <button class="ghost" onclick="(${delOP.toString()})('${o.id}')()">Borrar</button>
        </td>
      </tr>
    `).join('');
    tbody.innerHTML = rows || `<tr><td colspan="14" class="muted">Sin √≥rdenes</td></tr>`;
  }

  /* ===== Resumen / Remito ===== */
  function filtroResumen(){
    const cli = ($('f-cli').value||'').toLowerCase();
    const d1 = $('f-desde').value || null;
    const d2 = $('f-hasta').value || null;
    const list = cache.resumen.filter(r=> (cli?(r.cliente||'').toLowerCase().includes(cli):true) && (d1? r.fecha>=d1 : true) && (d2? r.fecha<=d2 : true));
    $('res-total').textContent = fmt2(list.reduce((a,r)=>a+(+r.precio_total||0),0));
    return list;
  }
  function renderResumen(){
    const data = filtroResumen();
    const tbody=document.querySelector('#tbl-resumen tbody');
    tbody.innerHTML = data.map(o=>`
      <tr>
        <td>${o.fecha}</td><td>${escapeHtml(o.cliente||'')}</td><td>${escapeHtml(o.prod_nombre||'')}</td>
        <td class="right">${o.cant}</td><td>${escapeHtml(o.unidad||'')}</td><td>${escapeHtml(o.envase||'')}</td>
        <td class="right">${fmt2(o.precio_total||0)}</td>
        <td class="right">${o.bulto!=null?fmt2(o.bulto):''}</td>
        <td>${escapeHtml(o.calidad||'')}</td>
        <td class="right">${o.kg!=null?fmt2(o.kg):''}</td>
        <td>${escapeHtml(o.respa||'')}</td>
      </tr>
    `).join('') || `<tr><td colspan="11" class="muted">Sin √≥rdenes finalizadas</td></tr>`;
  }
  $('f-cli').addEventListener('input', renderResumen);
  ['f-desde','f-hasta'].forEach(id=>$(id).addEventListener('input',renderResumen));
  $('f-limpiar').onclick = ()=>{ ['f-cli','f-desde','f-hasta'].forEach(i=>$(i).value=''); renderResumen(); };

  $('btn-print').onclick = ()=>{
    const data = filtroResumen(); if(!data.length) return toast('Sin datos');
    const cliente = ($('f-cli').value||'').trim(), d1=$('f-desde').value||'', d2=$('f-hasta').value||'';
    const total = data.reduce((a,x)=>a+(+x.precio_total||0),0);
    const html = `<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Remito</title>
    <style>body{font-family:Arial;margin:28px;color:#111}h1{margin:0 0 6px;font-size:22px}.sub{color:#444;font-size:12px;margin-bottom:12px}
    .meta{display:flex;justify-content:space-between;margin:12px 0 16px;font-size:14px}.box{border:1px solid #ccc;padding:10px;border-radius:8px}
    table{width:100%;border-collapse:collapse;margin-top:12px;font-size:13px}th,td{border:1px solid #ddd;padding:8px}th{background:#f5f5f5;text-align:left}
    .right{text-align:right}@media print{@page{size:A4 portrait;margin:20mm}}</style></head><body>
      <h1>Remito ‚Äì Tu PyME</h1>
      <div class="sub">Generado ${new Date().toLocaleString()}</div>
      <div class="meta"><div class="box"><div><b>Cliente:</b> ${escapeHtml(cliente||'Varios')}</div><div><b>Rango:</b> ${d1||'‚Äî'} a ${d2||'‚Äî'}</div></div><div class="box"><div><b>N¬∞:</b> REM-${Date.now()}</div></div></div>
      <table><thead><tr><th>Fecha</th><th>Producto</th><th>Cant</th><th>Unidad</th><th>Envase</th><th>Precio Total</th><th>Bulto</th><th>Calidad</th><th>Kg</th><th>Respa</th></tr></thead><tbody>
        ${data.map(o=>`<tr><td>${o.fecha}</td><td>${escapeHtml(o.prod_nombre||'')}</td><td class="right">${o.cant}</td><td>${escapeHtml(o.unidad||'')}</td><td>${escapeHtml(o.envase||'')}</td><td class="right">${fmt2(o.precio_total||0)}</td><td class="right">${o.bulto!=null?fmt2(o.bulto):''}</td><td>${escapeHtml(o.calidad||'')}</td><td class="right">${o.kg!=null?fmt2(o.kg):''}</td><td>${escapeHtml(o.respa||'')}</td></tr>`).join('')}
      </tbody></table><div style="text-align:right;margin-top:10px"><b>TOTAL: $ ${fmt2(total)}</b></div>
      <script>window.onload=function(){window.print();setTimeout(()=>window.close(),300);}<\/script>
    </body></html>`;
    const w=window.open('','_blank'); w.document.open(); w.document.write(html); w.document.close();
  };

  /* ===== Pendientes ===== */
  function getPendientes(){
    const prov=($('pp-prov').value||'').toLowerCase(), d1=$('pp-desde').value||null, d2=$('pp-hasta').value||null;
    return cache.pedidos
      .filter(p=>p.estado!=='Entregado' && p.estado!=='Cancelado')
      .filter(p=>prov?(p.prov||'').toLowerCase().includes(prov):true)
      .filter(p=>(d1?p.fecha>=d1:true) && (d2?p.fecha<=d2:true));
  }
  function renderPendientes(){
    const data=getPendientes();
    const proveedores=new Set(data.map(x=>x.prov||'')); $('pp-kpi-pend').textContent=data.length;
    $('pp-kpi-monto').textContent=fmt2(data.reduce((a,p)=>a+(+p.precio||0)*(+p.cant||0),0)); $('pp-kpi-prov').textContent=proveedores.size;
    const tbody=document.querySelector('#tbl-pendientes tbody');
    tbody.innerHTML = data.map(p=>{
      const recibido=(p.recibido!=null?+p.recibido:0), pendiente=Math.max(0,(+p.cant||0)-recibido), subtotal=(+p.precio||0)*(+p.cant||0);
      return `<tr>
        <td>${p.fecha}</td><td>${p.prov||''}</td><td>${p.codigo}</td><td>${escapeHtml(p.descripcion||'')}</td>
        <td>${p.cant}</td>
        <td><input type="number" class="num" min="0" step="0.01" value="${p.recibido??''}" placeholder="${p.cant}" oninput="(${setPedidoRecibido.toString()})('${p.id}')(this.value)"></td>
        <td>${fmt2(pendiente)}</td><td>${p.unidad||''}</td><td>${p.precio!=null?fmt2(+p.precio):'-'}</td><td>${fmt2(subtotal)}</td>
        <td>${p.bulto!=null?fmt2(p.bulto):'-'}</td><td>${escapeHtml(p.calidad||'-')}</td><td>${escapeHtml(p.envase||'-')}</td><td>${p.kg!=null?fmt2(p.kg):'-'}</td><td>${escapeHtml(p.respa||'-')}</td>
        <td class="right"><button class="ok" onclick="markPedidoEntregado('${p.id}')">Entregado</button></td>
      </tr>`;
    }).join('') || `<tr><td colspan="16" class="muted">Sin pendientes</td></tr>`;
  }
  ['pp-prov','pp-desde','pp-hasta'].forEach(id=>$(id).addEventListener('input', renderPendientes));
  $('pp-limpiar').onclick = ()=>{ ['pp-prov','pp-desde','pp-hasta'].forEach(i=>$(i).value=''); renderPendientes(); };
  $('pp-print').onclick = ()=>{
    const data=getPendientes(); if(!data.length) return toast('Sin datos');
    const html = `<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Pendientes</title><style>body{font-family:Arial;margin:28px;color:#111}h1{margin:0 0 6px;font-size:22px}.sub{color:#444;font-size:12px;margin-bottom:12px}table{width:100%;border-collapse:collapse;margin-top:12px;font-size:13px}th,td{border:1px solid #ddd;padding:8px}th{background:#f5f5f5;text-align:left}.right{text-align:right}@media print{@page{size:A4;margin:18mm}}</style></head><body>
    <h1>Pendientes de compra ‚Äì Tu PyME</h1><div class="sub">Generado ${new Date().toLocaleString()}</div>
    <table><thead><tr><th>Fecha</th><th>Proveedor</th><th>C√≥digo</th><th>Descripci√≥n</th><th>Pedida</th><th>Recibido</th><th>Pendiente</th><th>Unidad</th><th>Precio</th><th>Subtotal</th><th>Bulto</th><th>Calidad</th><th>Envase</th><th>Kg</th><th>Respa</th></tr></thead><tbody>${
      data.map(p=>`<tr><td>${p.fecha}</td><td>${p.prov||''}</td><td>${p.codigo}</td><td>${escapeHtml(p.descripcion||'')}</td><td class="right">${p.cant}</td><td class="right">${p.recibido??''}</td><td class="right">${fmt2(Math.max(0,(+p.cant||0)-(+p.recibido||0)))}</td><td>${p.unidad||''}</td><td class="right">${fmt2(+p.precio||0)}</td><td class="right">${fmt2((+p.precio||0)*(+p.cant||0))}</td><td class="right">${p.bulto!=null?fmt2(p.bulto):''}</td><td>${escapeHtml(p.calidad||'')}</td><td>${escapeHtml(p.envase||'')}</td><td class="right">${p.kg!=null?fmt2(p.kg):''}</td><td>${escapeHtml(p.respa||'')}</td></tr>`).join('')
    }</tbody></table><script>window.onload=function(){window.print();setTimeout(()=>window.close(),300);}<\/script></body></html>`;
    const w=window.open('','_blank'); w.document.open(); w.document.write(html); w.document.close();
  };

  /* ===== Config ‚ÄúCat√°logos‚Äù (productos/envases) - render m√≠nimo ===== */
  function renderProductos(){
    // (si quer√©s volver a ver la grilla editable de productos, lo agrego, por ahora se mantiene por API)
  }
  function renderEnvasesConf(){
    // idem arriba (alta/edici√≥n b√°sica ya incluida en la pesta√±a Envases)
  }

  /* ===== Tabs ===== */
  function activateTab(tab){ document.querySelectorAll('section[id^="tab-"]').forEach(s=>s.style.display='none'); document.querySelectorAll('.tab').forEach(b=>b.classList.remove('active')); const btn=document.querySelector(`.tab[data-tab="${tab}"]`); const sec=$('tab-'+tab); if(btn&&sec){ btn.classList.add('active'); sec.style.display='block'; } }
  $('tabsBar').addEventListener('click',(e)=>{ if(e.target.classList.contains('tab')) activateTab(e.target.dataset.tab); });

  /* ===== Init ===== */
  (async ()=>{ const { data:{ session } } = await supabase.auth.getSession(); if(session?.user){ await afterAuth(session.user); } else { showLogin(); } })();

  </script>

  <!-- ===== PARCHE: Limpieza de sesi√≥n/cookies al cerrar ===== -->
  <script>
  window.addEventListener("beforeunload", async () => {
    try { await supabase.auth.signOut(); } catch(e){}
    localStorage.removeItem('supabase.auth.token'); sessionStorage.removeItem('supabase.auth.token');
    localStorage.clear(); sessionStorage.clear();
    document.cookie.split(";").forEach(c=>{
      document.cookie = c.trim().split("=")[0] + "=;expires=Thu, 01 Jan 1970 00:00:00 UTC;path=/";
    });
  });
  </script>
</body>
</html>

