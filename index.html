<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Sistema PyME ‚Äì Frutas & Verduras (Supabase)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --bg:#0f172a; --card:#111827; --muted:#334155; --text:#e5e7eb; --accent:#8b5cf6; --ok:#10b981; --warn:#f59e0b; --err:#ef4444; }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,#1e1b4b,#0b1020);font-family:Inter,system-ui,Arial;color:var(--text)}
    header{padding:16px;border-bottom:1px solid #26314e;background:radial-gradient(1000px 350px at 10% -20%,#2a2e78 0%,transparent 55%);display:flex;align-items:center;gap:12px}
    h1{margin:0;font-size:18px;font-weight:700}
    .sub{opacity:.8;font-size:12px;margin-left:6px}
    .wrap{max-width:1150px;margin:14px auto;padding:0 12px}
    .tabs{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0 16px;align-items:center}
    .tab{background:#1f2937;border:1px solid #334155;color:#cbd5e1;padding:8px 12px;border-radius:10px;cursor:pointer;display:none}
    .tab.active{border-color:#8b5cf6;color:white;box-shadow:0 0 0 2px #8b5cf633 inset}
    .config{margin-left:auto;background:#0b162d;border:1px solid #2b3a5a;color:#cbd5e1;padding:8px 12px;border-radius:10px;cursor:pointer;display:none}
    .card{background:#0b1222;border:1px solid #22304b;border-radius:14px;padding:14px;margin-bottom:16px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media(max-width:800px){.grid{grid-template-columns:1fr}}
    label{font-size:12px;opacity:.85;margin-bottom:4px;display:block}
    input,select{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #334155;background:#0b162d;color:#e5e7eb}
    button{border:0;border-radius:10px;padding:10px 14px;cursor:pointer}
    .primary{background:var(--accent);color:white} .ghost{background:#111827;color:#cbd5e1;border:1px solid #2b3a5a}
    .ok{background:var(--ok);color:#052e22} .warn{background:var(--warn);color:#190d00} .err{background:var(--err);color:#2a0909}
    table{width:100%;border-collapse:collapse;margin-top:10px;font-size:14px}
    th,td{padding:10px;border-bottom:1px solid #22304b} th{text-align:left;opacity:.8}
    .tag{font-size:12px;padding:2px 8px;border-radius:999px;border:1px solid #334155;background:#0b162d;display:inline-block}
    .right{display:flex;gap:8px;justify-content:flex-end}
    #toast{position:fixed;top:16px;right:16px;display:none;min-width:220px;max-width:360px;padding:12px 14px;border-radius:12px;background:#111827;border:1px solid #2b3a5a;color:#e5e7eb;box-shadow:0 8px 30px #0006;z-index:9999}
    .muted{opacity:.7}
    .num{width:120px}
    .filters{display:grid;grid-template-columns:1fr 1fr 1fr auto auto;gap:8px;margin:8px 0}
    @media(max-width:900px){.filters{grid-template-columns:1fr 1fr}}
    .totalbar{margin-top:8px;display:flex;justify-content:flex-end;font-weight:700}
    .pricecell{display:flex;gap:6px;align-items:center}
    .kpis{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin:8px 0 4px}
    @media (max-width:900px){.kpis{grid-template-columns:1fr}}
    .kpi{background:#0b162d;border:1px solid #2b3a5a;border-radius:12px;padding:12px}
    .kpi .big{font-size:20px;font-weight:700}
    .userbox{margin-left:auto;display:flex;align-items:center;gap:8px}
    .logout{background:#1f2937;border:1px solid #334155;color:#cbd5e1;border-radius:10px;padding:6px 10px;cursor:pointer}
    #loginView{max-width:420px;margin:12vh auto;padding:16px}
    .link{color:#a78bfa;cursor:pointer;text-decoration:underline}
  
/* === UX Mejora Resumen === */
.tbl-resumen{width:100%; border-collapse:separate; border-spacing:0 8px;}
.tbl-resumen thead th{position:sticky; top:0; background:#0f172a; z-index:1; padding:10px; text-align:left; border-bottom:1px solid #233; }
.tbl-resumen tbody tr{background:#0b1220;}
.tbl-resumen tbody tr:hover{outline:1px solid #334; background:#0e1628;}
.tbl-resumen td{padding:8px 10px; border-bottom:1px dashed #223;}
.badge{display:inline-block; padding:.25rem .5rem; border-radius:999px; background:#1f2937;}
.kpi{display:inline-flex; gap:.4rem; align-items:baseline; padding:.4rem .7rem; border-radius:.75rem; background:#111827; border:1px solid #2b3548;}
.kpi b{font-size:1.1rem;}
.actions-right{display:flex; gap:.5rem; justify-content:flex-end; align-items:center;}
input.money{width:110px; text-align:right}

</style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js">
async function updatePV(id, value){
  // guarda si existe columna pv_total
  try{ await supabase.from('produccion').update({ pv_total: value }).eq('id', id); }catch(_){}
  const r = (cache.produccion||[]).find(x=>x.id===id); if(r){ r.pv_total = value; }
  renderResumen();
}

async function updateCU(id, value){
  // guarda si existe columna costo_unit
  try{ await supabase.from('produccion').update({ costo_unit: value }).eq('id', id); }catch(_){}
  const r = (cache.produccion||[]).find(x=>x.id===id); if(r){ r.costo_unit = value; }
  renderResumen();
}

function exportResumenCSV(){
  const table = document.getElementById('tbl-resumen');
  if(!table) return;
  const get = (sel, scope)=> Array.from((scope||table).querySelectorAll(sel));
  const lines = [];
  const head = get('thead th').map(th=> th.textContent.trim());
  lines.push(head);
  get('tbody tr').forEach(tr=>{
    const row = get('td,th', tr).map(td=> {
      const inp = td.querySelector('input');
      const val = inp? inp.value : td.textContent;
      const cell = String(val).replace(/"/g,'""');
      return `"${cell}"`;
    });
    lines.push(row);
  });
  const csv = lines.map(a=>a.join(',')).join('\n');
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'Resumen.csv';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
}

// Bind export button
setTimeout(()=>{
  const btn = document.getElementById('btn-resumen-export');
  if(btn){ btn.onclick = exportResumenCSV; }
}, 0);


// Eventos filtros resumen
(function(){
  const a = document.getElementById('res-f-aplicar');
  const l = document.getElementById('res-f-limpiar');
  const c = document.getElementById('res-f-cli');
  const d = document.getElementById('res-f-desde');
  const h = document.getElementById('res-f-hasta');
  if(a){ a.onclick = renderResumen; }
  if(c){ c.addEventListener('keyup', e=>{ if(e.key==='Enter') renderResumen(); }); }
  if(d){ d.onchange = renderResumen; }
  if(h){ h.onchange = renderResumen; }
  if(l){ l.onclick = ()=>{ if(c) c.value=''; if(d) d.value=''; if(h) h.value=''; renderResumen(); }; }
})();


$('tab-resumen')?.addEventListener('click', ()=>{ renderResumen(); });
</script>
</head>
<body>
  <header id="appHeader" style="display:none">
    <h1>Sistema PyME ‚Äì Frutas & Verduras</h1>
    <div class="sub">Sesi√≥n: <span id="whoami"></span></div>

<div id="resumen-filtros" style="display:flex; gap:.75rem; flex-wrap:wrap; align-items:end; margin:10px 0 8px;">
  <div style="display:flex; flex-direction:column;">
    <label style="font-size:.85rem; opacity:.8;">Cliente (contiene)</label>
    <input id="res-f-cli" type="text" placeholder="ej. raul" style="min-width:220px;">
  </div>
  <div style="display:flex; flex-direction:column;">
    <label style="font-size:.85rem; opacity:.8;">Desde</label>
    <input id="res-f-desde" type="date">
  </div>
  <div style="display:flex; flex-direction:column;">
    <label style="font-size:.85rem; opacity:.8;">Hasta</label>
    <input id="res-f-hasta" type="date">
  </div>
  <div style="margin-left:auto; display:flex; gap:.5rem;">
    <button id="res-f-aplicar" class="ok">Aplicar</button>
    <button id="res-f-limpiar" class="warn">Limpiar</button>
  </div>
</div>

    <div class="userbox">
      <span class="chip" id="roleChip" style="display:none"></span>
      <button class="logout" id="btn-logout">Cerrar sesi√≥n</button>
    </div>
  </header>

  <div id="toast"></div>

  <!-- ===== LOGIN ===== -->
  <div id="loginView" class="card">
    <h2>Ingresar</h2>
    <div class="grid">
      <div><label>Email</label><input id="lg-email" placeholder="correo@empresa.com" autocomplete="username" /></div>
      <div><label>Contrase√±a</label><input id="lg-pass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password" /></div>
    </div>
    <div class="right" style="margin-top:10px;gap:8px">
      <button class="ghost" id="btn-signup">Crear cuenta</button>
      <button class="primary" id="btn-login">Entrar</button>
    </div>
    <div class="muted" style="margin-top:8px">¬øOlvidaste tu clave? <span id="btn-reset" class="link">Restablecer</span></div>
  </div>

  <!-- ===== APP ===== -->
  <div id="app" class="wrap" style="display:none">
    <div class="tabs" id="tabsBar">
      <button class="tab" data-tab="pedidos">üßæ Pedidos</button>
      <button class="tab" data-tab="stock">üì¶ Stock</button>
      <button class="tab" data-tab="envases">üß¥ Envases</button>
      <button class="tab" data-tab="produccion">üè≠ Producci√≥n</button>
      <button class="tab" data-tab="resumen">üìÑ Resumen</button>
      <button class="tab" data-tab="pendientes">üìä Pedidos pendientes</button>
      <button class="tab" data-tab="historial">üìë Historial</button>
      <button class="tab" data-tab="usuarios">üë§ Usuarios</button>
      <button class="config" id="btn-config">‚öô Configuraci√≥n</button>
    </div>

    <!-- ===== PEDIDOS ===== -->
    <section class="card" id="tab-pedidos" style="display:none">
      <h2>Registrar pedido</h2>
      <div class="grid">
        <div><label>Fecha</label><input type="date" id="p-fecha" /></div>
        <div><label>Proveedor</label><input id="p-proveedor" /></div>
        <div><label>C√≥digo</label><input id="p-codigo" placeholder="ZAN-001 o PROD-001" /></div>
        <div><label>Descripci√≥n (se autocompleta)</label><input id="p-descripcion" /></div>
        <div><label>Cantidad pedida</label><input id="p-cant" class="num" type="number" min="0" step="0.01" /></div>
        <div><label>Unidad</label><select id="p-unidad"><option>kg</option><option>unid</option><option>bandejas</option><option>paquetes</option></select></div>
        <div><label>Precio unitario</label><input id="p-precio" class="num" type="number" min="0" step="0.01" /></div>
        <div><label>Estado</label><select id="p-estado"><option>Pendiente</option><option>Entregado</option><option>Cancelado</option></select></div>

        <!-- NUEVOS CAMPOS -->
        <div><label>Cantidad Bulto</label><input id="p-bulto" class="num" type="number" min="0" step="0.01" /></div>
        <div><label>Calidad</label><input id="p-calidad" /></div>
        <div><label>Envase</label><input id="p-envase" placeholder="C√≥digo de envase (p.ej. CAJA-1KG)" /></div>
        <div><label>Descripci√≥n envase</label><input id="p-envase-desc" placeholder="(se completa solo)" readonly /></div>
        <div><label>Respa</label><input id="p-respa" /></div>
        <div><label>Kg</label><input id="p-kg" class="num" type="number" min="0" step="0.01" /></div>
      </div>
      <div class="right" style="margin-top:10px">
        <button class="ghost" id="p-limpiar">Limpiar</button>
        <button class="primary" id="p-crear">Crear pedido</button>
      </div>
      <table id="tbl-pedidos"><thead><tr>
        <th>Fecha</th><th>C√≥digo</th><th>Descripci√≥n</th><th>Prov.</th>
        <th>Pedida</th><th>Recibido</th><th>Unidad</th><th>Precio</th>
        <th>Cant. Bulto</th><th>Calidad</th><th>Envase</th><th>Kg</th><th>Respa</th>
        <th>Estado</th><th></th>
      </tr></thead><tbody></tbody></table>
    </section>

    <!-- ===== STOCK ===== -->
    <section class="card" id="tab-stock" style="display:none">
      <h2>Stock</h2>
      <div class="right" style="margin-bottom:8px">
        <button class="err" id="btn-reset-stock">Reiniciar stock (todo a 0)</button>
      </div>
      <table id="tbl-stock"><thead><tr>
        <th>C√≥digo</th><th>Descripci√≥n</th><th>Stock</th><th>Unidad</th><th>Pto. Reposici√≥n</th><th>Alerta</th>
      </tr></thead><tbody></tbody></table>
    </section>

    <!-- ===== STOCK ENVASES ===== -->
    <section class="card" id="tab-envases" style="display:none">
      <h2>Control de stock de envases</h2>
      <div class="right" style="margin-bottom:8px">
        <button class="err" id="btn-reset-envases">Reiniciar envases (todo a 0)</button>
      </div>
      <table id="tbl-envases">
        <thead>
          <tr>
            <th>C√≥digo</th><th>Descripci√≥n</th><th>Stock</th><th>Unidad</th><th>Pto. Reposici√≥n</th><th>Alerta</th><th>Acciones</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <!-- ===== PRODUCTOS (CONFIG) ===== -->
    <section class="card" id="tab-productos" style="display:none">
      <h2>Cat√°logo de productos</h2>
      <div class="grid">
        <div><label>C√≥digo</label><input id="pd-codigo" /></div>
        <div><label>Descripci√≥n</label><input id="pd-descripcion" /></div>
        <div><label>Unidad</label><select id="pd-unidad"><option>bandejas</option><option>kg</option><option>paquetes</option><option>unid</option></select></div>
        <div><label>Envase</label><input id="pd-envase" /></div>
      </div>
      <div class="right" style="margin-top:10px"><button class="primary" id="pd-agregar">Agregar producto</button></div>
      <table id="tbl-productos"><thead><tr><th>C√≥digo</th><th>Descripci√≥n</th><th>Unidad</th><th>Envase</th><th></th></tr></thead><tbody></tbody></table>

      <h2 style="margin-top:20px">Cat√°logo de envases</h2>
      <div class="grid">
        <div><label>C√≥digo</label><input id="ev-codigo" /></div>
        <div><label>Descripci√≥n</label><input id="ev-descripcion" /></div>
        <div><label>Unidad</label><input id="ev-unidad" /></div>
      </div>
      <div class="right" style="margin-top:10px"><button class="primary" id="ev-agregar">Agregar envase</button></div>
      <table id="tbl-envases-conf">
        <thead><tr><th>C√≥digo</th><th>Descripci√≥n</th><th>Unidad</th><th></th></tr></thead>
        <tbody></tbody>
      </table>
    </section>

    <!-- ===== PRODUCCI√ìN ===== -->
    <section class="card" id="tab-produccion" style="display:none">
      <h2>Orden de producci√≥n</h2>
      <div class="grid">
        <div><label>Fecha</label><input type="date" id="pr-fecha" /></div>
        <div><label>Producto final (c√≥digo o descripci√≥n)</label><input id="pr-desc" /></div>
        <div><label>Cliente</label><input id="pr-cliente" /></div>
        <div><label>Cantidad</label><input id="pr-cant" type="number" min="0" step="0.01" /></div>
        <div><label>Unidad</label><select id="pr-unidad"><option>bandejas</option><option>kg</option><option>paquetes</option><option>unid</option></select></div>
        <div><label>Envase</label><input id="pr-envase" /></div>
        <div><label>INSUMO (c√≥digo)</label><input id="pr-insumo" placeholder="ZAN-001" /></div>
        <div><label>Consumo</label><input id="pr-insumo-cant" type="number" min="0" step="0.01" /></div>
        <div><label>Estado</label><select id="pr-estado"><option>En proceso</option><option>Terminado</option></select></div>
        <div style="grid-column:1/-1"><label>Observaciones</label><input id="pr-obs" /></div>

        <!-- NUEVOS CAMPOS -->
        <div><label>Cantidad Bulto</label><input id="pr-bulto" type="number" min="0" step="0.01" /></div>
        <div><label>Calidad</label><input id="pr-calidad" /></div>
        <div><label>Kg</label><input id="pr-kg" type="number" min="0" step="0.01" /></div>
        <div><label>Respa</label><input id="pr-respa" /></div>
      </div>
      <div class="right" style="margin-top:10px"><button class="primary" id="pr-crear">Crear orden</button></div>
      <table id="tbl-prod"><thead><tr>
        <th>Fecha</th><th>Cliente</th><th>Producto</th><th>Cant</th><th>Unidad</th><th>Envase</th><th>Insumo</th><th>Consumo</th>
        <th>Bulto</th><th>Calidad</th><th>Kg</th><th>Respa</th>
        <th>Estado</th><th></th>
      </tr></thead><tbody></tbody></table>
    </section>

    <!-- ===== RESUMEN ===== -->
    <section class="card" id="tab-resumen" style="display:none">
      <h2>√ìrdenes finalizadas (para Remito)</h2>
<div id="resumen-kpis" class="actions-right" style="margin-bottom:10px"></div>
      <div class="filters">
        <div><label>Cliente (contiene)</label><input id="f-cli" /></div>
        <div><label>Desde</label><input type="date" id="f-desde" /></div>
        <div><label>Hasta</label><input type="date" id="f-hasta" /></div>
        <div class="right" style="align-items:end"><button class="ghost" id="f-limpiar">Limpiar</button></div>
        <div class="right" style="align-items:end"><button class="primary" id="btn-print">Imprimir Remito</button>
<button id="btn-resumen-export" class="ok">Exportar Excel</button></div>
      </div>
      <table id="tbl-resumen" class="tbl-resumen"><thead><tr><th>Fecha</th><th>Cliente</th><th>Producto</th><th>Cant</th><th>Unidad</th><th>Envase</th><th>PV Total</th><th>Costo Unit</th><th>Costo Total</th><th>Margen</th><th>%</th><th>Bulto</th><th>Calidad</th><th>Kg</th><th>Respa</th><th>Obs</th></tr></thead><tbody></tbody></table>
      <div class="totalbar">Total filtrado: $ <span id="res-total">0.00</span></div>
    </section>

    <!-- ===== PEDIDOS PENDIENTES ===== -->
    <section class="card" id="tab-pendientes" style="display:none">
      <h2>Pedidos pendientes (Compras)</h2>
      <div class="kpis">
        <div class="kpi"><div class="muted">√ìrdenes pendientes</div><div class="big" id="pp-kpi-pend">0</div></div>
        <div class="kpi"><div class="muted">Monto estimado</div><div class="big">$ <span id="pp-kpi-monto">0.00</span></div></div>
        <div class="kpi"><div class="muted">Proveedores activos</div><div class="big" id="pp-kpi-prov">0</div></div>
      </div>
      <div class="filters">
        <div><label>Proveedor (contiene)</label><input id="pp-prov" /></div>
        <div><label>Desde</label><input type="date" id="pp-desde" /></div>
        <div><label>Hasta</label><input type="date" id="pp-hasta" /></div>
        <div class="right" style="align-items:end"><button class="ghost" id="pp-limpiar">Limpiar filtros</button></div>
        <div class="right" style="align-items:end"><button class="primary" id="pp-print">Imprimir</button></div>
      </div>
      <table id="tbl-pendientes"><thead><tr>
        <th>Fecha</th><th>Proveedor</th><th>C√≥digo</th><th>Descripci√≥n</th>
        <th>Pedida</th><th>Recibido</th><th>Pendiente</th><th>Unidad</th><th>Precio</th><th>Subtotal</th>
        <th>Cant. Bulto</th><th>Calidad</th><th>Envase</th><th>Kg</th><th>Respa</th>
        <th>Acciones</th>
      </tr></thead><tbody></tbody></table>
    </section>

    <!-- ===== HISTORIAL ===== -->
    <section class="card" id="tab-historial" style="display:none">
      <h2>Historial de movimientos de stock</h2>
      <table id="tbl-historial"><thead><tr>
        <th>Fecha</th><th>C√≥digo</th><th>Descripci√≥n</th><th class="right">Cambio</th><th>Unidad</th><th>Motivo</th>
      </tr></thead><tbody></tbody></table>
    </section>

    <!-- ===== USUARIOS ===== -->
    <section class="card" id="tab-usuarios" style="display:none">
      <h2>Gesti√≥n de usuarios y permisos</h2>
      <div class="grid">
        <div><label>User ID (Auth)</label><input id="u-id" placeholder="Pega aqu√≠ el UUID del usuario" /></div>
        <div><label>Nombre visible</label><input id="u-name" placeholder="Juan P√©rez" /></div>
        <div><label>Rol</label><select id="u-role"><option value="admin">admin</option><option value="operador">operador</option><option value="consulta">consulta</option></select></div>
        <div><label>Permisos (coma)</label><input id="u-perms" placeholder="pedidos,stock,produccion,..." /></div>
      </div>
      <div class="right" style="margin-top:10px">
        <button class="ghost" id="u-refresh">Refrescar</button>
        <button class="primary" id="u-guardar">Guardar / Actualizar</button>
      </div>
      <table id="tbl-users"><thead><tr><th>User ID</th><th>Nombre</th><th>Rol</th><th>Permisos</th></tr></thead><tbody></tbody></table>
      <p class="muted" style="margin-top:6px">üí° Cada usuario hace ‚ÄúCrear cuenta‚Äù. Copi√° su <b>User ID</b> desde Supabase Auth o desde este listado y ac√° le asign√°s rol/permisos.</p>
    </section>
  </div>

  <script>
  /* ===== CONFIG SUPABASE (las tuyas) ===== */
  const SUPABASE_URL = "https://zxbzjdobgrlabbfqwsag.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp4YnpqZG9iZ3JsYWJiZnF3c2FnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc1MTg3OTcsImV4cCI6MjA3MzA5NDc5N30.DmgzIiRSsZ_yEl9MfLd2R6n3zbaghq2JB4FLcKb4KNs";
  const { createClient } = window.supabase;
  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// === Helper: envoltorio seguro para acciones async ===
function safeAsync(fn){
  return async (...args)=>{
    try { return await fn(...args); }
    catch(err){
      try { console.error(err); } catch(_){}
      try { toast(err?.message || String(err)); } catch(_){ alert(String(err)); }
      return null;
    }
  };
}


// -- Bot√≥n Cerrar sesi√≥n (robusto)
document.addEventListener("DOMContentLoaded", ()=>{
  const b = document.getElementById("btn-logout");
  if(b) b.onclick = safeAsync(async ()=>{
    await supabase.auth.signOut();
    showLogin();
    toast("Sesi√≥n cerrada");
  });
});


// === Debounce para evitar carreras de updates ===
const _debounces = {};
function debounceSave(fn, key, ms=300){
  try{ clearTimeout(_debounces[key]); }catch(_){}
  _debounces[key] = setTimeout(fn, ms);
}


  /* ===== Estado / Helpers ===== */
  const cache = { org:null, profile:null, perms:[], products:[], envases:[], stock:{}, pedidos:[], prod:[], resumen:[], hist:[], users:[] };
  const $ = id=>document.getElementById(id);
  const fmt2 = n => (isFinite(n)?Number(n).toFixed(2):'');
  function toast(m){ const t=$('toast'); t.style.display='block'; t.textContent=m; setTimeout(()=>t.style.display='none',2000); }
  function escapeHtml(s){ if(s==null) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
  const can = p => cache.perms.includes(p);

  /* ===== Login / Signup PARCHEADO (ensureBootstrap) ===== */
  const ALL_PERMS = ['pedidos','stock','envases','produccion','resumen','pendientes','historial','config','usuarios','stock_reset','pedidos_entregar','produccion_terminar','resumen_borrar','resumen_print'];

  $('btn-login').onclick = async ()=>{
    const email=$('lg-email').value.trim(), pass=$('lg-pass').value;
    const { data, error } = await supabase.auth.signInWithPassword({ email, password:pass });
    if(error){ toast(error.message); return; }
    await ensureBootstrap(data.user);
    await afterAuth(data.user);
  };
  $('btn-signup').onclick = async ()=>{
    const email=$('lg-email').value.trim(), pass=$('lg-pass').value;
    if(!email||!pass){ toast('Complet√° email y contrase√±a'); return; }
    const { data, error } = await supabase.auth.signUp({ email, password:pass });
    if(error){ toast(error.message); return; }
    if(!data.session){
      toast('Te enviamos un email para confirmar. Luego presion√° "Entrar".');
    } else {
      await ensureBootstrap(data.user);
      await afterAuth(data.user);
    }
  };
  $('btn-reset').onclick = async ()=>{
    const email = prompt('Email para restablecer:'); if(!email) return;
    const { error } = await supabase.auth.resetPasswordForEmail(email);
    toast(error?error.message:'Te enviamos un email de restablecimiento');
  };
  $('btn-logout').onclick = async ()=>{ await supabase.auth.signOut(); showLogin(); };
  supabase.auth.onAuthStateChange(async (ev, session)=>{
    if(ev==='SIGNED_IN' && session?.user){ await ensureBootstrap(session.user); await afterAuth(session.user); try{ wireEnvaseDescripcion(); }catch(_){ } }
    if(ev==='SIGNED_OUT'){ showLogin(); }
  });
  async function ensureBootstrap(user){
    const { data:profile } = await supabase.from('profiles').select('*').eq('user_id', user.id).maybeSingle();
    if(profile) return;
    const { data:org, error:e1 } = await supabase.from('orgs').insert({ name:'Mi PyME', owner:user.id }).select().single();
    if(e1){ toast('Error creando organizaci√≥n: '+e1.message); return; }
    const { error:e2 } = await supabase.from('profiles').insert({ user_id:user.id, org_id:org.id, name:'Administrador', role:'admin', perms:ALL_PERMS });
    if(e2){ toast('Error creando perfil: '+e2.message); return; }
    toast('Organizaci√≥n y perfil admin creados.');
  }
  function showLogin(){ $('appHeader').style.display='none'; $('app').style.display='none'; $('loginView').style.display='block'; }
  function showApp(){ $('loginView').style.display='none'; $('appHeader').style.display='flex'; $('app').style.display='block'; }

  /* ===== Post login ===== */
  async function afterAuth(user){
    const { data:profile } = await supabase.from('profiles').select('*').eq('user_id', user.id).maybeSingle();
    if(!profile){ toast('No ten√©s perfil. Ped√≠ acceso al admin.'); showLogin(); return; }
    cache.profile = profile; cache.org={ id:profile.org_id }; cache.perms = profile.perms||[];
    if(profile.role==='admin' && !cache.perms.includes('resumen_editar')) cache.perms.push('resumen_editar');
    if(profile.role==='admin' && !cache.perms.includes('envases')) cache.perms.push('envases');

    $('whoami').textContent = user.email; const rc=$('roleChip'); rc.style.display='none'; rc.textContent=profile.role;
    document.querySelectorAll('.tab').forEach(b=>{ const tab=b.dataset.tab; b.style.display = cache.perms.includes(tab)?'inline-block':'none'; });
    $('btn-config').style.display = cache.perms.includes('config')?'inline-block':'none';
    showApp();
    await loadAll();
    renderProductos(); renderEnvasesConf(); renderStock(); renderEnvasesStock(); renderPedidos(); renderProduccion(); renderResumen(); renderPendientes(); renderHistorial(); await renderUsers();
    const first = Array.from(document.querySelectorAll('.tab')).find(b=>b.style.display!=='none'); if(first) activateTab(first.dataset.tab);
  }

  /* ===== Carga de datos ===== */
  async function loadAll(){
    const org=cache.org.id;
    const [{data:products=[]},{data:stockRows=[]},{data:pedidos=[]},{data:prod=[]},{data:resumen=[]},{data:hist=[]},{data:envases=[]}] = await Promise.all([
      supabase.from('products').select('*').eq('org_id',org),
      supabase.from('stock').select('*').eq('org_id',org),
      supabase.from('pedidos').select('*').eq('org_id',org).order('created_at',{ascending:false}),
      supabase.from('produccion').select('*').eq('org_id',org).order('created_at',{ascending:false}),
      supabase.from('resumen').select('*').eq('org_id',org).order('created_at',{ascending:false}),
      supabase.from('historial_stock').select('*').eq('org_id',org).order('fecha',{ascending:false}),
      supabase.from('envases').select('*').eq('org_id',org)
    ]);
    cache.products=products;
    cache.stock=Object.fromEntries(stockRows.map(s=>[s.codigo,s]));
    cache.pedidos=pedidos; cache.prod=prod; cache.resumen=resumen; cache.hist=hist; cache.envases=envases;
  }

  /* ===== Productos ===== */
  $('btn-config').onclick = ()=>{
    if(!can('config')) return toast('Sin permiso');
    const sec = $('tab-productos'); sec.style.display = (sec.style.display==='none'||!sec.style.display)?'block':'none';
  };
  $('pd-agregar').onclick = async ()=>{
    if(!can('config')) return toast('Sin permiso');
    const codigo=$('pd-codigo').value.trim(), descripcion=$('pd-descripcion').value.trim(), unidad=$('pd-unidad').value, envase=$('pd-envase').value.trim();
    if(!codigo||!descripcion) return toast('C√≥digo y descripci√≥n');
    const org=cache.org.id;
    const { data:exist } = await supabase.from('products').select('id').eq('org_id',org).eq('codigo',codigo).maybeSingle();
    if(exist) return toast('C√≥digo ya existe');
    const { error } = await supabase.from('products').insert({ org_id:org, codigo, descripcion, unidad, envase });
    if(error) return toast(error.message);
    await loadAll(); renderProductos(); toast('Producto agregado'); ['pd-codigo','pd-descripcion','pd-envase'].forEach(i=>$(i).value='');
  };
  function delProducto(code){ return async ()=>{
    if(!can('config')) return toast('Sin permiso');
    const org=cache.org.id; const row=cache.products.find(p=>p.codigo===code); if(!row) return;
    const { error } = await supabase.from('products').delete().eq('id',row.id);
    if(error) return toast(error.message); await loadAll(); renderProductos(); toast('Producto borrado');
  }; }
  function renderProductos(){
    const tbody=document.querySelector('#tbl-productos tbody');
    tbody.innerHTML = cache.products.map(p=>`
      <tr><td>${p.codigo}</td><td>${p.descripcion}</td><td>${p.unidad||''}</td><td>${p.envase||''}</td>
      <td class="right"><button class="ghost" onclick="(${delProducto.toString()})('${p.codigo}')()">Borrar</button></td></tr>
    `).join('') || `<tr><td colspan="5" class="muted">Sin productos</td></tr>`;
  }
  const prodByCode = c => cache.products.find(p=>(p.codigo||'').toLowerCase()===String(c||'').toLowerCase());
  const prodByAny = v => cache.products.find(p => (p.codigo||'').toLowerCase()===String(v||'').toLowerCase() || (p.descripcion||'').toLowerCase()===String(v||'').toLowerCase());

  /* ===== Config: Envases (alta/baja) ===== */
  $('ev-agregar').onclick = async ()=>{
    if(!can('config')) return toast('Sin permiso');
    const codigo=$('ev-codigo').value.trim(), descripcion=$('ev-descripcion').value.trim(), unidad=$('ev-unidad').value.trim();
    if(!codigo||!descripcion) return toast('C√≥digo y descripci√≥n');
    const org=cache.org.id;
    const { data:exist } = await supabase.from('envases').select('id').eq('org_id',org).eq('codigo',codigo).maybeSingle();
    if(exist) return toast('C√≥digo ya existe');
    const { error } = await supabase.from('envases').insert({ org_id:org, codigo, descripcion, unidad });
    if(error) return toast(error.message);
    await loadAll(); renderEnvasesConf(); toast('Envase agregado'); ['ev-codigo','ev-descripcion','ev-unidad'].forEach(i=>$(i).value='');
  };

  function delEnvaseConf(code){ return async ()=>{
    if(!can('config')) return toast('Sin permiso');
    const org=cache.org.id; const row=cache.envases.find(e=>e.codigo===code); if(!row) return;
    const { error } = await supabase.from('envases').delete().eq('id',row.id);
    if(error) return toast(error.message); await loadAll(); renderEnvasesConf(); toast('Envase borrado');
  }; }

  function renderEnvasesConf(){
    const tbody=document.querySelector('#tbl-envases-conf tbody');
    if(!tbody) return;
    tbody.innerHTML = cache.envases.map(e=>`
      <tr><td>${e.codigo}</td><td>${e.descripcion}</td><td>${e.unidad||''}</td>
      <td class="right"><button class="ghost" onclick="(${delEnvaseConf.toString()})('${e.codigo}')()">Borrar</button></td></tr>
    `).join('') || `<tr><td colspan="4" class="muted">Sin envases</td></tr>`;
  }

  /* ===== Stock & Historial ===== */
  async function sbUpsertStock({codigo,descripcion,unidad,delta,motivo}){
    const org=cache.org.id; const row=cache.stock[codigo];
    if(row){
      const newQty = (Number(row.qty)||0) + Number(delta||0);
      const { error } = await supabase.from('stock').update({ qty:newQty, descripcion: row.descripcion||descripcion, unidad: row.unidad||unidad }).eq('id',row.id);
      if(error) throw error; cache.stock[codigo].qty=newQty;
    }else{
      const { data, error } = await supabase.from('stock').insert({ org_id:org, codigo, descripcion, unidad, qty:Number(delta||0) }).select().single();
      if(error) throw error; cache.stock[codigo]=data;
    }
    await supabase.from('historial_stock').insert({ org_id:org, codigo, descripcion, delta, unidad, motivo: motivo||'' });
  }
  async function sbConsumeStock(codigo,qty,motivo){
    const row=cache.stock[codigo]; if(!row) return false;
    if((Number(row.qty)||0) < (Number(qty)||0)) return false;
    await sbUpsertStock({codigo, descripcion:row.descripcion, unidad:row.unidad, delta:-Number(qty), motivo});
    return true;
  }
  $('btn-reset-stock').onclick = async ()=>{
    if(!can('stock_reset')) return toast('Sin permiso');
    const rows=Object.values(cache.stock); const org=cache.org.id;
    for(const r of rows){ if(Number(r.qty||0)!==0){ await supabase.from('historial_stock').insert({ org_id:org, codigo:r.codigo, descripcion:r.descripcion, delta:-Number(r.qty||0), unidad:r.unidad, motivo:'Reset a 0' }); } }
    const { error } = await supabase.from('stock').update({ qty:0 }).eq('org_id',org);
    if(error) return toast(error.message);
    await loadAll(); renderStock(); renderHistorial(); toast('Stock reiniciado');
  };
  function setRepo(codigo){ return async (val)=>{
    const row=cache.stock[codigo]; if(!row) return;
    const { error } = await supabase.from('stock').update({ repo: Number(val)||0 }).eq('id',row.id);
    if(error) return toast(error.message);
    cache.stock[codigo].repo = Number(val)||0;
  }; }
  function renderStock(){
    const tbody=document.querySelector('#tbl-stock tbody');
    const rows = Object.entries(cache.stock)
      .filter(([c,s])=>(Number(s.qty)||0)>0)
      .map(([c,s])=>{
        const alert = (s.repo && (Number(s.qty)||0)<=s.repo) ? '‚ö†Ô∏è Bajo' : '';
        return `<tr><td>${c}</td><td>${s.descripcion||''}</td><td>${fmt2(+s.qty||0)}</td><td>${s.unidad||''}</td>
          <td><input type="number" min="0" step="0.01" value="${s.repo||0}" style="width:110px" oninput="(${setRepo.toString()})('${c}')(this.value)"></td>
          <td>${alert}</td></tr>`;
      }).join('');
    tbody.innerHTML = rows || `<tr><td colspan="6" class="muted">Sin insumos en stock</td></tr>`;
    $('btn-reset-stock').style.display = can('stock_reset')?'inline-block':'none';
  }
  function renderHistorial(){
    const tbody=document.querySelector('#tbl-historial tbody');
    tbody.innerHTML = cache.hist.map(h=>`
      <tr><td>${new Date(h.fecha).toLocaleString()}</td><td>${h.codigo||''}</td><td>${h.descripcion||''}</td>
      <td class="right">${h.delta>0?'+':''}${fmt2(h.delta)}</td><td>${h.unidad||''}</td><td>${h.motivo||''}</td></tr>
    `).join('') || `<tr><td colspan="6" class="muted">Sin movimientos</td></tr>`;
  }

  /* ===== Stock de Envases: helpers ===== */
  $('btn-reset-envases').onclick = async ()=>{
    if(!can('stock_reset')) return toast('Sin permiso');
    const org=cache.org.id;
    const { error } = await supabase.from('envases').update({ stock:0 }).eq('org_id',org);
    if(error) return toast(error.message);
    await loadAll(); renderEnvasesStock(); toast('Stock de envases reiniciado');
  };
  function setRepoEnvase(codigo){ return async (val)=>{
    const row=cache.envases.find(e=>e.codigo===codigo); if(!row) return;
    const { error } = await supabase.from('envases').update({ repo:Number(val)||0 }).eq('id',row.id);
    if(error) return toast(error.message);
    row.repo=Number(val)||0;
  }; }
  
  function renderEnvasesStock(){
    const tbody=document.querySelector('#tbl-envases tbody');
    const rows = cache.envases.map(e=>{
      const alert = (e.repo && (Number(e.stock)||0)<=e.repo) ? '‚ö†Ô∏è Bajo' : '';
      return `<tr>
        <td>${e.codigo}</td>
        <td>${e.descripcion}</td>
        <td>${fmt2(+e.stock||0)}</td>
        <td>${e.unidad||''}</td>
        <td><input type="number" min="0" step="0.01" value="${e.repo||0}" style="width:110px" oninput="(${setRepoEnvase.toString()})('${e.codigo}')(this.value)"></td>
        <td>${alert}</td>
        <td class="right">
          <button class="ok" onclick="(${ajusteEnvaseManual.toString()})('${e.codigo}', +1)()">+ Agregar</button>
          <button class="warn" onclick="(${ajusteEnvaseManual.toString()})('${e.codigo}', -1)()">‚àí Quitar</button>
        </td>
      </tr>`;
    }).join('');
    tbody.innerHTML = rows || `<tr><td colspan="7" class="muted">Sin envases</td></tr>`;
  }


  /* === NUEVO: Ajuste de stock de Envases (+ historial opcional) === */
  
  
  
  // === Ajuste de stock de Envases (funci√≥n √∫nica, limpia) ===
async function sbAdjustEnvaseStock(codigo, delta, motivo){
  const org = cache.org?.id;
  const norm = (v)=>String(v||'').trim().toLowerCase();
  const code = norm(codigo);

  // 1) Buscar en cache
  let row = (cache.envases || []).find(e => norm(e.codigo) === code);

  // 2) Si no est√°, buscar en DB
  if(!row){
    try{
      const { data } = await supabase
        .from('envases')
        .select('*')
        .eq('org_id', org)
        .ilike('codigo', codigo)
        .maybeSingle();
      if(data) row = data;
    }catch(_){}
  }

  if(!row){
    return { ok:false, msg:'Envase no encontrado (' + codigo + ')' };
  }

  // 3) Actualizar stock
  const nuevo = Number(row.stock||0) + Number(delta||0);
  const { error:e1 } = await supabase
    .from('envases')
    .update({ stock: nuevo })
    .eq('id', row.id);
  if(e1) throw e1;

  // 4) Historial opcional
  try{
    await supabase.from('envases_historial').insert({
      org_id: org,
      codigo: row.codigo,
      descripcion: row.descripcion || '',
      delta: Number(delta||0),
      unidad: row.unidad || '',
      motivo: motivo || ''
    });
  }catch(_){}

  // 5) Refrescar cache (si estaba) o empujar
  const local = (cache.envases || []).find(e => norm(e.codigo) === code);
  if(local){
    local.stock = nuevo;
  } else if (Array.isArray(cache.envases)) {
    cache.envases.push({ ...row, stock: nuevo });
  }

  return { ok:true, stock: nuevo };
}

// Ajuste manual de envases (desde la tabla)
  function ajusteEnvaseManual(codigo, signo){
    return async ()=>{
      const txt = prompt(`Cantidad a ${signo>0?'AGREGAR':'QUITAR'} para ${codigo}:`, '0');
      const qty = Number((txt||'').replace(',','.'));
      if(!isFinite(qty) || qty<=0) return;
      await sbAdjustEnvaseStock(codigo, signo*qty, `Ajuste manual (${signo>0?'+':'-'}${qty})`);
      await loadAll(); renderEnvasesStock();
      toast('Stock de envases actualizado');
    };
  }
  /* ===== Pedidos ===== */
  $('p-codigo').addEventListener('blur', ()=>{
    const p=prodByCode(($('p-codigo').value||'').trim().toLowerCase());
    if(p){
      $('p-descripcion').value=p.descripcion||$('p-descripcion').value;
      $('p-unidad').value=p.unidad||$('p-unidad').value;
      if(p.envase) $('p-envase').value = p.envase;
    }
  });

  // Crear pedido + descuento de envases (si corresponde)
  $('p-crear').onclick = async ()=>{
    if(!can('pedidos')) return toast('Sin permiso');
    const pedido = {
      fecha: $('p-fecha').value || new Date().toISOString().slice(0,10),
      codigo: $('p-codigo').value.trim(),
      descripcion: $('p-descripcion').value.trim(),
      prov: $('p-proveedor').value.trim(),
      cant: parseFloat($('p-cant').value||0),
      recibido: null, recibido_aplicado: 0,
      unidad: $('p-unidad').value, precio: parseFloat($('p-precio').value||0),
      estado: $('p-estado').value,
      bulto: parseFloat($('p-bulto').value||0),
      calidad: $('p-calidad').value.trim(),
      envase: $('p-envase').value.trim(),   // C√≥digo de envase
      kg: parseFloat($('p-kg').value||0),
      respa: $('p-respa').value.trim()
    };
    if(!pedido.codigo || !pedido.cant) return toast('C√≥digo y cantidad');
    const prod=prodByCode(pedido.codigo);
    if(prod){
      if(!pedido.descripcion) pedido.descripcion=prod.descripcion;
      if(!pedido.unidad) pedido.unidad=prod.unidad;
      if(!pedido.envase) pedido.envase=prod.envase||'';
    }
    const org=cache.org.id;

    // Insertar y recuperar fila creada
    const { data: row, error: eIns } = await supabase
      .from('pedidos')
      .insert({ org_id:org, ...pedido })
      .select()
      .single();
    if(eIns) return toast(eIns.message);

    // Si hay envase v√°lido y bulto > 0, descontar stock de envases
    let aplicado = 0;
    const tieneCodigoEnvase = cache.envases.some(e => (e.codigo||'').toLowerCase() === (pedido.envase||'').toLowerCase());
    if (tieneCodigoEnvase && Number(pedido.bulto||0) > 0){
      try{
        await sbAdjustEnvaseStock(pedido.envase, +Number(pedido.bulto), `Entrada por pedido ${row.id}`);
        aplicado = Number(pedido.bulto);
      }catch(err){
        console.error(err);
        toast('No se pudo descontar stock de envases');
      }
    }

    // Guardar cu√°nto bulto de envase se aplic√≥ (si existe la columna)
    if (aplicado > 0){
      try{
        await supabase.from('pedidos')
          .update({ bulto_aplicado_envase: aplicado })
          .eq('id', row.id);
      }catch(_){ /* ignora si la columna no existe */ }
    }

    // Si est√° Entregado, aplicar recepci√≥n al stock del producto
    if(pedido.estado==='Entregado'){
      const rec = (pedido.recibido!=null)?pedido.recibido:pedido.cant;
      await sbUpsertStock({ codigo:pedido.codigo, descripcion:pedido.descripcion, unidad:pedido.unidad, delta:rec, motivo:`Recepci√≥n pedido ${row.id}` });
      await supabase.from('pedidos').update({ recibido_aplicado: rec }).eq('id',row.id);
    }

    await loadAll(); renderPedidos(); renderStock(); renderHistorial(); renderPendientes(); renderEnvasesStock();
    toast('Pedido creado');
  };

  $('p-limpiar').onclick = ()=>{ ['p-fecha','p-codigo','p-descripcion','p-proveedor','p-cant','p-precio','p-bulto','p-calidad','p-envase','p-kg','p-respa'].forEach(i=>$(i).value=''); $('p-estado').value='Pendiente'; };

  function setPedidoRecibido(id){ return async (val)=>{
    const rec = (val===''?null:Math.max(0,parseFloat(val||0)));
    const { error } = await supabase.from('pedidos').update({ recibido: rec }).eq('id',id);
    if(error) return toast(error.message);
    await loadAll(); renderPedidos(); renderPendientes();
  }; }
  async function markPedidoEntregado(id){
    if(!can('pedidos_entregar')) return toast('Sin permiso');
    const { data:p } = await supabase.from('pedidos').select('*').eq('id',id).maybeSingle();
    if(!p) return;
    const recTarget = (p.recibido!=null? p.recibido : p.cant);
    const diff = recTarget - (p.recibido_aplicado||0);
    if(Math.abs(diff)>0){
      await sbUpsertStock({ codigo:p.codigo, descripcion:p.descripcion||'', unidad:p.unidad||'', delta:diff, motivo:`Recepci√≥n pedido ${id}` });
    }
    await supabase.from('pedidos').update({ estado:'Entregado', recibido_aplicado: recTarget }).eq('id',id);
    await loadAll(); renderPedidos(); renderStock(); renderPendientes(); renderHistorial(); toast('Entregado');
  }

  // BORRAR pedido: revierte stock de producto y de envases si aplic√≥
  function delPedido(id){ return async ()=>{
    const p = cache.pedidos.find(x=>x.id===id); if(!p) return;

    // Reversa de stock de producto
    if (p.recibido_aplicado){
      await sbUpsertStock({ codigo:p.codigo, descripcion:p.descripcion||'', unidad:p.unidad||'', delta:-p.recibido_aplicado, motivo:`Reverso recepci√≥n ${id}` });
    }

    // Reversa de envases (si se descontaron bultos)
    const tieneCodigoEnvase = cache.envases.some(e => (e.codigo||'').toLowerCase() === String(p.envase||'').toLowerCase());
    const bultoAplic = Number(p.bulto_aplicado_envase||0);
    if (tieneCodigoEnvase && bultoAplic > 0){
      try{
        await sbAdjustEnvaseStock(p.envase, -bultoAplic, `Reversa entrada envase pedido ${id}`);
      }catch(err){ console.error(err); }
    }

    await supabase.from('pedidos').delete().eq('id',id);

    await loadAll(); renderPedidos(); renderStock(); renderHistorial(); renderPendientes(); renderEnvasesStock();
    toast('Pedido borrado');
  }; }

  function renderPedidos(){
    const tbody=document.querySelector('#tbl-pedidos tbody');
    tbody.innerHTML = cache.pedidos.map(p=>`
      <tr>
        <td>${p.fecha}</td><td>${p.codigo}</td><td>${p.descripcion||'-'}</td><td>${p.prov||'-'}</td>
        <td>${p.cant}</td>
        <td><input type="number" class="num" min="0" step="0.01" value="${p.recibido??''}" placeholder="${p.cant}" oninput="(${setPedidoRecibido.toString()})('${p.id}')(this.value)"></td>
        <td>${p.unidad||'-'}</td><td>${p.precio!=null?fmt2(p.precio):'-'}</td>
        <td>${p.bulto!=null?fmt2(p.bulto):'-'}</td>
        <td>${p.calidad||'-'}</td>
        <td>${p.envase||'-'}</td>
        <td>${p.kg!=null?fmt2(p.kg):'-'}</td>
        <td>${p.respa||'-'}</td>
        <td><span class="tag">${p.estado}</span></td>
        <td class="right">
          ${can('pedidos_entregar')?`<button class="ok" onclick="markPedidoEntregado('${p.id}')">Entregado</button>`:''}
          <button class="ghost" onclick="(${delPedido.toString()})('${p.id}')()">Borrar</button>
        </td>
      </tr>
    `).join('') || `<tr><td colspan="15" class="muted">Sin pedidos</td></tr>`;
  }

  /* ===== Producci√≥n ===== */
  $('pr-desc').addEventListener('blur', ()=>{
    const p=prodByAny(($('pr-desc').value||'').trim()); if(p){ $('pr-unidad').value=p.unidad||$('pr-unidad').value; $('pr-envase').value=p.envase||$('pr-envase').value; if(String(p.codigo).toLowerCase()===String($('pr-desc').value).toLowerCase()) $('pr-desc').value=p.descripcion; }
  });
  $('pr-crear').onclick = async ()=>{
    if(!can('produccion')) return toast('Sin permiso');
    const o = {
      fecha:$('pr-fecha').value||new Date().toISOString().slice(0,10),
      cliente:$('pr-cliente').value.trim(),
      codigo_prod:null, prod_nombre:$('pr-desc').value.trim(),
      cant:parseFloat($('pr-cant').value||0),
      unidad:$('pr-unidad').value, envase:$('pr-envase').value.trim(),
      ins:$('pr-insumo').value.trim(), ins_cant:parseFloat($('pr-insumo-cant').value||0),
      estado:$('pr-estado').value, obs:$('pr-obs').value.trim(),
      bulto: parseFloat($('pr-bulto').value||0),
      calidad: $('pr-calidad').value.trim(),
      kg: parseFloat($('pr-kg').value||0),
      respa: $('pr-respa').value.trim()
    };
    if(!o.prod_nombre||!o.cant||!o.ins||!o.ins_cant) return toast('Completar producto/cant/insumo');
    const pm = prodByAny(o.prod_nombre); if(pm){ o.codigo_prod=pm.codigo; o.prod_nombre=pm.descripcion; o.unidad=o.unidad||pm.unidad; o.envase=o.envase||pm.envase; }
    const row=cache.stock[o.ins]; if(!row || (Number(row.qty)||0) < Number(o.ins_cant||0)) return toast('Stock insuficiente');
    await sbConsumeStock(o.ins, o.ins_cant, 'Consumo producci√≥n');
    const org=cache.org.id;
    const { data:insOP, error } = await supabase.from('produccion').insert({ org_id:org, ...o, consumo_aplicado:o.ins_cant }).select().single();
    
    // === Consumo de ENVASES por OP (usa "bulto" como cantidad de envases) ===
    try{
      const norm = (v)=>String(v||'').trim().toLowerCase();
      const existeEnvase = (cache.envases||[]).some(e => norm(e.codigo) === norm(o.envase));
      const bultos = Number(o.bulto||0);
      if (bultos > 0 && (existeEnvase || norm(o.envase)) && insOP?.id){
        const r = await sbAdjustEnvaseStock(o.envase, -bultos, `Consumo envase OP ${insOP.id}`);
        if(!r?.ok){ toast(r?.msg || 'No se encontr√≥ el envase'); }
        try{
          await supabase.from('produccion').update({ env_bulto_aplicado: bultos }).eq('id', insOP.id);
        }catch(_){}
      }
    }catch(e){ console.error(e); toast('No se pudo aplicar consumo de envases'); }

    if(error) return toast(error.message);
    if(o.estado==='Terminado') await upsertResumenFromOP(insOP);
    await loadAll(); renderProduccion(); renderStock(); renderHistorial(); renderResumen(); renderEnvasesStock(); toast('Orden creada');
  };
  async function upsertResumenFromOP(o){
    const org=cache.org.id;
    const prodNombre = o.prod_nombre || (o.codigo_prod ? (cache.products.find(p=>p.codigo===o.codigo_prod)?.descripcion || '') : '');
    const payload = {
      org_id:org, id_op:o.id, fecha:o.fecha, cliente:o.cliente, prod_nombre:prodNombre, codigo_prod:o.codigo_prod||null,
      cant:o.cant, unidad:o.unidad, envase:o.envase, obs:o.obs,
      bulto: o.bulto ?? null,
      calidad: o.calidad ?? null,
      kg: o.kg ?? null,
      respa: o.respa ?? null
    };
    const { data:exists } = await supabase.from('resumen').select('id').eq('org_id',org).eq('id_op',o.id).maybeSingle();
    if(exists) await supabase.from('resumen').update(payload).eq('id',exists.id);
    else await supabase.from('resumen').insert(payload);
  }
  async function markOPTerminado(id){
    if(!can('produccion_terminar')) return toast('Sin permiso');
    const { data:o } = await supabase.from('produccion').select('*').eq('id',id).maybeSingle();
    if(!o) return; if(o.estado==='Terminado') return toast('Ya terminada');
    await supabase.from('produccion').update({ estado:'Terminado' }).eq('id',id);
    await upsertResumenFromOP(o); await loadAll(); renderProduccion(); renderResumen(); toast('Orden migrada');
  }
  function delOP(id){ return async ()=>{
    const o=cache.prod.find(x=>x.id===id); if(!o) return;
    if(o.consumo_aplicado){ await sbUpsertStock({ codigo:o.ins, descripcion:cache.stock[o.ins]?.descripcion||'', unidad:cache.stock[o.ins]?.unidad||'', delta:o.consumo_aplicado, motivo:`Reverso consumo ${id}` }); }
    
    // Reversa de consumo de envases si se aplic√≥
    try{
      const existeEnvase = cache.envases.some(e => (e.codigo||'').toLowerCase() === String(o.envase||'').toLowerCase());
      const bAplic = Number(o.env_bulto_aplicado||0);
      if (existeEnvase && bAplic > 0){
        await sbAdjustEnvaseStock(o.envase, +bAplic, `Reversa consumo envase OP ${id}`);
      }
    }catch(e){ console.error(e); }
await supabase.from('produccion').delete().eq('id',id);
    await supabase.from('resumen').delete().eq('id_op',id);
    await loadAll(); renderProduccion(); renderResumen(); renderStock(); renderHistorial(); toast('Orden borrada');
  }; }
  function renderProduccion(){
    const tbody=document.querySelector('#tbl-prod tbody');
    const rows = cache.prod.map(o=>`
      <tr>
        <td>${o.fecha}</td><td>${o.cliente||'-'}</td>
        <td>${o.prod_nombre||''}${o.codigo_prod?` <span class="muted">(${o.codigo_prod})</span>`:''}</td>
        <td>${o.cant}</td><td>${o.unidad||''}</td><td>${o.envase||''}</td>
        <td>${o.ins}</td><td>${o.ins_cant}</td>
        <td>${o.bulto!=null?fmt2(o.bulto):'-'}</td>
        <td>${o.calidad||'-'}</td>
        <td>${o.kg!=null?fmt2(o.kg):'-'}</td>
        <td>${o.respa||'-'}</td>
        <td><span class="tag">${o.estado}</span></td>
        <td class="right">
          ${can('produccion_terminar')&&o.estado==='En proceso'?`<button class="ok" onclick="markOPTerminado('${o.id}')">Terminar</button>`:''}
          <button class="ghost" onclick="(${delOP.toString()})('${o.id}')()">Borrar</button>
        </td>
      </tr>
    `).join('');
    tbody.innerHTML = rows || `<tr><td colspan="14" class="muted">Sin √≥rdenes</td></tr>`;
  }

  /* ===== Resumen / Remito ===== */
  $('btn-print').onclick = ()=>{
    if(!can('resumen_print')) return toast('Sin permiso');
    const data = filtroResumen(); if(!data.length) return toast('Sin datos');

    const cliente = ($('f-cli').value||'').trim(),
          d1 = $('f-desde').value || '',
          d2 = $('f-hasta').value || '',
          total = data.reduce((a,x)=>a+(+x.precio_total||0),0);

    const html = `<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Remito</title>
    <style>
      body{font-family:Arial;margin:28px;color:#111}
      h1{margin:0 0 6px;font-size:22px}
      .sub{color:#444;font-size:12px;margin-bottom:12px}
      .meta{display:flex;justify-content:space-between;margin:12px 0 16px;font-size:14px}
      .box{border:1px solid #ccc;padding:10px;border-radius:8px}
      table{width:100%;border-collapse:collapse;margin-top:12px;font-size:13px}
      th,td{border:1px solid #ddd;padding:8px}
      th{background:#f5f5f5;text-align:left}
      .right{text-align:right}
      .total{margin-top:10px;display:flex;justify-content:flex-end;font-size:16px;font-weight:bold}
      @media print{@page{size:A4 portrait;margin:20mm}}
    </style></head><body>
      <h1>Remito ‚Äì Tu PyME</h1>
      <div class="sub">Generado ${new Date().toLocaleString()}</div>
      <div class="meta">
        <div class="box">
          <div><b>Cliente:</b> ${escapeHtml(cliente||'Varios')}</div>
          <div><b>Rango:</b> ${d1||'‚Äî'} a ${d2||'‚Äî'}</div>
        </div>
        <div class="box"><div><b>N¬∞:</b> REM-${Date.now()}</div></div>
      </div>
      <table>
        <thead>
          <tr><th>Fecha</th><th>Producto</th><th>Cant</th><th>Unidad</th><th>Envase</th><th>Precio Total</th><th>Bulto</th><th>Calidad</th><th>Kg</th><th>Respa</th><th>Obs</th></tr>
        </thead>
        <tbody>
          ${data.map(o=>`
            <tr>
              <td>${o.fecha}</td>
              <td>${escapeHtml(o.prod_nombre||'')}</td>
              <td class="right">${o.cant}</td>
              <td>${escapeHtml(o.unidad||'')}</td>
              <td>${escapeHtml(o.envase||'')}</td>
              <td class="right">${fmt2(o.precio_total||0)}</td>
              <td class="right">${o.bulto!=null?fmt2(o.bulto):''}</td>
              <td>${escapeHtml(o.calidad||'')}</td>
              <td class="right">${o.kg!=null?fmt2(o.kg):''}</td>
              <td>${escapeHtml(o.respa||'')}</td>
              <td>${escapeHtml(o.obs||'')}</td>
            </tr>`).join('')}
        </tbody>
      </table>
      <div class="total">TOTAL: $ ${fmt2(total)}</div>
      <scr${''}ipt>window.onload=function(){window.print();setTimeout(()=>window.close(),300);}<\/script>
    
<scr${''}ipt>
// Captura global de errores para evitar que la app "se congele"
window.addEventListener('error', (e) => {
  try { console.error(e.error || e.message); } catch(_) {}
  try { toast('Error: ' + (e.error?.message || e.message)); } catch(_) { alert(e.message); }
});
window.addEventListener('unhandledrejection', (e) => {
  try { console.error(e.reason); } catch(_) {}
  try { toast('Error: ' + (e.reason?.message || e.reason)); } catch(_) { alert(e.reason); }
});
</scr${''}ipt>

</body></html>`;

    const w = window.open('','_blank');
    w.document.open(); w.document.write(html); w.document.close();
  };

  function filtroResumen(){
    const cli = ($('f-cli').value||'').toLowerCase();
    const d1 = $('f-desde').value || null;
    const d2 = $('f-hasta').value || null;
    const list = cache.resumen.filter(r=> (cli?(r.cliente||'').toLowerCase().includes(cli):true) && (d1? r.fecha>=d1 : true) && (d2? r.fecha<=d2 : true));
    $('res-total').textContent = fmt2(list.reduce((a,r)=>a+(+r.precio_total||0),0));
    return list;
  }
  $('f-cli').addEventListener('input',()=>{ renderResumen(); });
  ['f-desde','f-hasta'].forEach(id=>$(id).addEventListener('input',()=>{ renderResumen(); }));

  function setResumenField(id, field){ 
  return async (val) => {
    debounceSave(async () => {
      const payload = {};
      if(field === 'precio_total'){
        payload[field] = (val==='' ? null : Number(val)||0);
      } else {
        payload[field] = val;
      }
      const { error } = await supabase.from('resumen').update(payload).eq('id', id);
      if(error){ toast(error.message); return; }
      await loadAll(); renderResumen();
    }, `${id}:${field}`, 350);
  };
}





function isFinalOP(r){
  const s = String((r && r.estado) || '').toLowerCase().trim();
  return s.includes('final') || s.includes('termin');
}
function safeDate10(d){ return (d ? String(d).slice(0,10) : ''); }




function renderResumen(){
  var tbody = document.querySelector('#tbl-resumen tbody');
  if(!tbody) return;
  var fmt = function(n){ return isFinite(n)? fmt2(n) : '0.00'; };

  // Fuente: cache.resumen si existe; sino cache.produccion
  var src = (cache.resumen && cache.resumen.length) ? cache.resumen : (cache.produccion || []);

  // Filtros (usa barra interna; si est√° vac√≠a intenta con la superior)
  var fcliEl   = document.getElementById('res-f-cli')   || document.getElementById('r-cli');
  var fdesdeEl = document.getElementById('res-f-desde') || document.getElementById('r-desde');
  var fhastaEl = document.getElementById('res-f-hasta') || document.getElementById('r-hasta');
  var fcli   = (fcliEl   && fcliEl.value   ? fcliEl.value   : '').trim().toLowerCase();
  var fdesde = (fdesdeEl && fdesdeEl.value ? fdesdeEl.value : '').trim();
  var fhasta = (fhastaEl && fhastaEl.value ? fhastaEl.value : '').trim();

  function inRange(d){
    var x = safeDate10(d);
    if(fdesde && x < fdesde) return false;
    if(fhasta && x > fhasta) return false;
    return true;
  }

  // Si viene de produccion, quedate solo con estados finales
  var rowsAll = src.filter(function(r){
    if ('estado' in r) return isFinalOP(r);
    return true;
  });

  // Aplicar filtros
  var rows = rowsAll.filter(function(r){
    var cli = String(r.cliente||'').toLowerCase();
    var okCli = !fcli || cli.indexOf(fcli) !== -1;
    var okDate = inRange(r.fecha);
    return okCli && okDate;
  });

  var totalPV=0, totalCosto=0, totalMargen=0;
  var htmlRows = rows.map(function(r){
    var pv = Number(r.pv_total||0);
    var cu = Number(r.costo_unit||0);
    var cant = Number(r.cant||0);
    var ct = cu * cant;
    var mg = pv - ct;
    var pct = pv>0 ? (mg/pv*100) : 0;
    totalPV += pv; totalCosto += ct; totalMargen += mg;

    return '<tr>'
      + '<td>' + escapeHtml(safeDate10(r.fecha)) + '</td>'
      + '<td>' + escapeHtml(r.cliente||'') + '</td>'
      + '<td>' + escapeHtml(r.prod||r.producto||'') + '</td>'
      + '<td class="right">' + fmt(cant) + '</td>'
      + '<td>' + escapeHtml(r.unidad||'') + '</td>'
      + '<td>' + escapeHtml(r.envase||'') + '</td>'
      + '<td><input class="money" type="number" step="0.01" value="' + (pv||0) + '" oninput="(function(el,id){ var v=Number(el.value||0); updatePV(id,v); })(this,\'' + (r.id||'') + '\')"></td>'
      + '<td><input class="money" type="number" step="0.01" value="' + (cu||0) + '" oninput="(function(el,id){ var v=Number(el.value||0); updateCU(id,v); })(this,\'' + (r.id||'') + '\')"></td>'
      + '<td class="right">' + fmt(ct) + '</td>'
      + '<td class="right">' + fmt(mg) + '</td>'
      + '<td class="right">' + fmt2(pct) + '%</td>'
      + '<td class="right">' + fmt(r.bulto||0) + '</td>'
      + '<td>' + escapeHtml(r.calidad||'') + '</td>'
      + '<td class="right">' + fmt(r.kg||0) + '</td>'
      + '<td>' + escapeHtml(r.respa||'') + '</td>'
      + '<td>' + escapeHtml(r.obs||'') + '</td>'
      + '</tr>';
  }).join('');

  tbody.innerHTML = htmlRows || '<tr><td colspan="16" class="muted">Sin √≥rdenes finalizadas</td></tr>';

  // KPIs
  var kpis = document.getElementById('resumen-kpis');
  if(kpis){
    var pctG = totalPV>0 ? (totalMargen/totalPV*100) : 0;
    var kpiHtml = [
      '<div class="kpi"><span>Venta</span><b>$ ' + fmt(totalPV) + '</b></div>',
      '<div class="kpi"><span>Costo</span><b>$ ' + fmt(totalCosto) + '</b></div>',
      '<div class="kpi"><span>Margen</span><b>$ ' + fmt(totalMargen) + '</b> <span>' + fmt2(pctG) + '%</span></div>'
    ].join('');
    kpis.innerHTML = kpiHtml;
  }
}


  // si viene de produccion, quedate solo con estados finales
  var rowsAll = src.filter(function(r){
    if ('estado' in r) return isFinalOP(r);
    return true;
  });

  var rows = rowsAll.filter(function(r){
    var cli = String(r.cliente||'').toLowerCase();
    var okCli = !fcli || cli.indexOf(fcli) !== -1;
    var okDate = inRange(r.fecha);
    return okCli && okDate;
  });

  var totalPV=0, totalCosto=0, totalMargen=0;
  var htmlRows = rows.map(function(r){
    var pv = Number(r.pv_total||0);
    var cu = Number(r.costo_unit||0);
    var cant = Number(r.cant||0);
    var ct = cu * cant;
    var mg = pv - ct;
    var pct = pv>0 ? (mg/pv*100) : 0;
    totalPV += pv; totalCosto += ct; totalMargen += mg;

    return '<tr>'
      + '<td>' + escapeHtml(safeDate10(r.fecha)) + '</td>'
      + '<td>' + escapeHtml(r.cliente||'') + '</td>'
      + '<td>' + escapeHtml(r.prod||r.producto||'') + '</td>'
      + '<td class="right">' + fmt(cant) + '</td>'
      + '<td>' + escapeHtml(r.unidad||'') + '</td>'
      + '<td>' + escapeHtml(r.envase||'') + '</td>'
      + '<td><input class="money" type="number" step="0.01" value="' + (pv||0) + '" oninput="(function(el,id){ var v=Number(el.value||0); updatePV(id,v); })(this,\'' + (r.id||'') + '\')"></td>'
      + '<td><input class="money" type="number" step="0.01" value="' + (cu||0) + '" oninput="(function(el,id){ var v=Number(el.value||0); updateCU(id,v); })(this,\'' + (r.id||'') + '\')"></td>'
      + '<td class="right">' + fmt(ct) + '</td>'
      + '<td class="right">' + fmt(mg) + '</td>'
      + '<td class="right">' + fmt2(pct) + '%</td>'
      + '<td class="right">' + fmt(r.bulto||0) + '</td>'
      + '<td>' + escapeHtml(r.calidad||'') + '</td>'
      + '<td class="right">' + fmt(r.kg||0) + '</td>'
      + '<td>' + escapeHtml(r.respa||'') + '</td>'
      + '<td>' + escapeHtml(r.obs||'') + '</td>'
      + '</tr>';
  }).join('');

  tbody.innerHTML = htmlRows || '<tr><td colspan="16" class="muted">Sin √≥rdenes finalizadas</td></tr>';

  // KPIs
  var kpis = document.getElementById('resumen-kpis');
  if(kpis){
    var pctG = totalPV>0 ? (totalMargen/totalPV*100) : 0;
    var kpiHtml = [
      '<div class="kpi"><span>Venta</span><b>$ ' + fmt(totalPV) + '</b></div>',
      '<div class="kpi"><span>Costo</span><b>$ ' + fmt(totalCosto) + '</b></div>',
      '<div class="kpi"><span>Margen</span><b>$ ' + fmt(totalMargen) + '</b> <span>' + fmt2(pctG) + '%</span></div>'
    ].join('');
    kpis.innerHTML = kpiHtml;
  }
// adaptar campos si vienen de resumen (sin estado) o de produccion (con estado)
  const rowsAll = src.filter(function(r){
    if ('estado' in r) return isFinalOP(r);
    return true;
  });

  const rows = rowsAll.filter(function(r){
    const cli = String(r.cliente||'').toLowerCase();
    const okCli = !fcli || cli.includes(fcli);
    const okDate = inRange(r.fecha);
    return okCli && okDate;
  });

  let totalPV=0, totalCosto=0, totalMargen=0;
  const htmlRows = rows.map(function(r){
    const pv = Number(r.pv_total||0);
    const cu = Number(r.costo_unit||0);
    const cant = Number(r.cant||0);
    const ct = cu * cant;
    const mg = pv - ct;
    const pct = pv>0 ? (mg/pv*100) : 0;
    totalPV += pv; totalCosto += ct; totalMargen += mg;

    return '<tr>'
      + '<td>' + escapeHtml(safeDate10(r.fecha)) + '</td>'
      + '<td>' + escapeHtml(r.cliente||'') + '</td>'
      + '<td>' + escapeHtml(r.prod||r.producto||'') + '</td>'
      + '<td class="right">' + fmt(cant) + '</td>'
      + '<td>' + escapeHtml(r.unidad||'') + '</td>'
      + '<td>' + escapeHtml(r.envase||'') + '</td>'
      + '<td><input class="money" type="number" step="0.01" value="' + (pv||0) + '" oninput="(function(el,id){ var v=Number(el.value||0); updatePV(id,v); })(this,\'' + (r.id||'') + '\')"></td>'
      + '<td><input class="money" type="number" step="0.01" value="' + (cu||0) + '" oninput="(function(el,id){ var v=Number(el.value||0); updateCU(id,v); })(this,\'' + (r.id||'') + '\')"></td>'
      + '<td class="right">' + fmt(ct) + '</td>'
      + '<td class="right">' + fmt(mg) + '</td>'
      + '<td class="right">' + fmt2(pct) + '%</td>'
      + '<td class="right">' + fmt(r.bulto||0) + '</td>'
      + '<td>' + escapeHtml(r.calidad||'') + '</td>'
      + '<td class="right">' + fmt(r.kg||0) + '</td>'
      + '<td>' + escapeHtml(r.respa||'') + '</td>'
      + '<td>' + escapeHtml(r.obs||'') + '</td>'
      + '</tr>';
  }).join('');

  tbody.innerHTML = htmlRows || '<tr><td colspan="16" class="muted">Sin √≥rdenes finalizadas</td></tr>';

  
// KPIs
var kpis = document.getElementById('resumen-kpis');
if(kpis){
  var pctG = totalPV>0 ? (totalMargen/totalPV*100) : 0;
  var kpiHtml = [
    '<div class="kpi"><span>Venta</span><b>$ ' + fmt(totalPV) + '</b></div>',
    '<div class="kpi"><span>Costo</span><b>$ ' + fmt(totalCosto) + '</b></div>',
    '<div class="kpi"><span>Margen</span><b>$ ' + fmt(totalMargen) + '</b> <span>' + fmt2(pctG) + '%</span></div>'
  ].join('');
  kpis.innerHTML = kpiHtml;
}

const rows = rowsAll.filter(function(r){
    var cli = String(r.cliente||'').toLowerCase();
    var okCli = !fcli || cli.includes(fcli);
    var okDate = inRange(r.fecha);
    return okCli && okDate;
  });

  var totalPV=0, totalCosto=0, totalMargen=0;
  const htmlRows = rows.map(function(r){
    var pv = Number(r.pv_total||0);
    var cu = Number(r.costo_unit||0);
    var cant = Number(r.cant||0);
    var ct = cu * cant;
    var mg = pv - ct;
    var pct = pv>0 ? (mg/pv*100) : 0;
    totalPV += pv; totalCosto += ct; totalMargen += mg;

    return '<tr>'
      + '<td>' + escapeHtml(r.fecha||'') + '</td>'
      + '<td>' + escapeHtml(r.cliente||'') + '</td>'
      + '<td>' + escapeHtml(r.prod||r.producto||'') + '</td>'
      + '<td class="right">' + fmt(cant) + '</td>'
      + '<td>' + escapeHtml(r.unidad||'') + '</td>'
      + '<td>' + escapeHtml(r.envase||'') + '</td>'
      + '<td><input class="money" type="number" step="0.01" value="' + (pv||0) + '" oninput="(function(el,id){ var v=Number(el.value||0); updatePV(id,v); })(this,\'' + r.id + '\')"></td>'
      + '<td><input class="money" type="number" step="0.01" value="' + (cu||0) + '" oninput="(function(el,id){ var v=Number(el.value||0); updateCU(id,v); })(this,\'' + r.id + '\')"></td>'
      + '<td class="right">' + fmt(ct) + '</td>'
      + '<td class="right">' + fmt(mg) + '</td>'
      + '<td class="right">' + fmt2(pct) + '%</td>'
      + '<td class="right">' + fmt(r.bulto||0) + '</td>'
      + '<td>' + escapeHtml(r.calidad||'') + '</td>'
      + '<td class="right">' + fmt(r.kg||0) + '</td>'
      + '<td>' + escapeHtml(r.respa||'') + '</td>'
      + '<td>' + escapeHtml(r.obs||'') + '</td>'
      + '</tr>';
  }).join('');

  if(htmlRows){
    tbody.innerHTML = htmlRows;
  }else{
    tbody.innerHTML = '<tr><td colspan="16" class="muted">Sin √≥rdenes finalizadas</td></tr>';
  }

  
// KPIs
var kpis = document.getElementById('resumen-kpis');
if(kpis){
  var pctG = totalPV>0 ? (totalMargen/totalPV*100) : 0;
  var kpiHtml = [
    '<div class="kpi"><span>Venta</span><b>$ ' + fmt(totalPV) + '</b></div>',
    '<div class="kpi"><span>Costo</span><b>$ ' + fmt(totalCosto) + '</b></div>',
    '<div class="kpi"><span>Margen</span><b>$ ' + fmt(totalMargen) + '</b> <span>' + fmt2(pctG) + '%</span></div>'
  ].join('');
  kpis.innerHTML = kpiHtml;
}

/* ===== Pendientes ===== */
  function getPendientes(){
    const prov=($('pp-prov').value||'').toLowerCase(), d1=$('pp-desde').value||null, d2=$('pp-hasta').value||null;
    return cache.pedidos
      .filter(p=>p.estado!=='Entregado' && p.estado!=='Cancelado')
      .filter(p=>prov?(p.prov||'').toLowerCase().includes(prov):true)
      .filter(p=>(d1?p.fecha>=d1:true) && (d2?p.fecha<=d2:true));
  }
  function renderPendientes(){
    const data=getPendientes();
    const proveedores=new Set(data.map(x=>x.prov||'')); $('pp-kpi-pend').textContent=data.length;
    $('pp-kpi-monto').textContent=fmt2(data.reduce((a,p)=>a+(+p.precio||0)*(+p.cant||0),0)); $('pp-kpi-prov').textContent=proveedores.size;
    const tbody=document.querySelector('#tbl-pendientes tbody');
    tbody.innerHTML = data.map(p=>{
      const recibido=(p.recibido!=null?+p.recibido:0), pendiente=Math.max(0,(+p.cant||0)-recibido), subtotal=(+p.precio||0)*(+p.cant||0);
      return `<tr>
        <td>${p.fecha}</td><td>${p.prov||''}</td><td>${p.codigo}</td><td>${p.descripcion||''}</td>
        <td>${p.cant}</td>
        <td><input type="number" class="num" min="0" step="0.01" value="${p.recibido??''}" placeholder="${p.cant}" oninput="(${setPedidoRecibido.toString()})('${p.id}')(this.value)"></td>
        <td>${fmt2(pendiente)}</td><td>${p.unidad||''}</td><td>${p.precio!=null?fmt2(+p.precio):'-'}</td><td>${fmt2(subtotal)}</td>
        <td>${p.bulto!=null?fmt2(p.bulto):'-'}</td>
        <td>${p.calidad||'-'}</td>
        <td>${p.envase||'-'}</td>
        <td>${p.kg!=null?fmt2(p.kg):'-'}</td>
        <td>${p.respa||'-'}</td>
        <td class="right">${can('pedidos_entregar')?`<button class="ok" onclick="markPedidoEntregado('${p.id}')">Entregado</button>`:''}</td>
      </tr>`;
    }).join('') || `<tr><td colspan="16" class="muted">Sin pendientes</td></tr>`;
  }
  ['pp-prov','pp-desde','pp-hasta'].forEach(id=>$(id).addEventListener('input', renderPendientes));
  $('pp-limpiar').onclick = ()=>{ ['pp-prov','pp-desde','pp-hasta'].forEach(i=>$(i).value=''); renderPendientes(); };
  $('pp-print').onclick = ()=>{
    const data=getPendientes(); if(!data.length) return toast('Sin datos');
    const html = `<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Pendientes</title><style>body{font-family:Arial;margin:28px;color:#111}h1{margin:0 0 6px;font-size:22px}.sub{color:#444;font-size:12px;margin-bottom:12px}table{width:100%;border-collapse:collapse;margin-top:12px;font-size:13px}th,td{border:1px solid #ddd;padding:8px}th{background:#f5f5f5;text-align:left}.right{text-align:right}@media print{@page{size:A4;margin:18mm}}</style></head><body>
    <h1>Pendientes de compra ‚Äì Tu PyME</h1><div class="sub">Generado ${new Date().toLocaleString()}</div>
    <table><thead><tr><th>Fecha</th><th>Proveedor</th><th>C√≥digo</th><th>Descripci√≥n</th><th>Pedida</th><th>Recibido</th><th>Pendiente</th><th>Unidad</th><th>Precio</th><th>Subtotal</th><th>Bulto</th><th>Calidad</th><th>Envase</th><th>Kg</th><th>Respa</th></tr></thead><tbody>${
      data.map(p=>`<tr><td>${p.fecha}</td><td>${p.prov||''}</td><td>${p.codigo}</td><td>${p.descripcion||''}</td><td class="right">${p.cant}</td><td class="right">${p.recibido??''}</td><td class="right">${fmt2(Math.max(0,(+p.cant||0)-(+p.recibido||0)))}</td><td>${p.unidad||''}</td><td class="right">${fmt2(+p.precio||0)}</td><td class="right">${fmt2((+p.precio||0)*(+p.cant||0))}</td><td class="right">${p.bulto!=null?fmt2(p.bulto):''}</td><td>${escapeHtml(p.calidad||'')}</td><td>${escapeHtml(p.envase||'')}</td><td class="right">${p.kg!=null?fmt2(p.kg):''}</td><td>${escapeHtml(p.respa||'')}</td></tr>`).join('')
    }</tbody></table><scr${''}ipt>window.onload=function(){window.print();setTimeout(()=>window.close(),300);}<\/script>
<scr${''}ipt>
// Captura global de errores para evitar que la app "se congele"
window.addEventListener('error', (e) => {
  try { console.error(e.error || e.message); } catch(_) {}
  try { toast('Error: ' + (e.error?.message || e.message)); } catch(_) { alert(e.message); }
});
window.addEventListener('unhandledrejection', (e) => {
  try { console.error(e.reason); } catch(_) {}
  try { toast('Error: ' + (e.reason?.message || e.reason)); } catch(_) { alert(e.reason); }
});
</scr${''}ipt>

</body></html>`;
    const w=window.open('','_blank'); w.document.open(); w.document.write(html); w.document.close();
  };

  /* ===== Usuarios ===== */
  async function renderUsers(){
    if(!can('usuarios')){ $('tab-usuarios').style.display='none'; return; }
    const org=cache.org.id;
    const { data:users=[] } = await supabase.from('profiles').select('*').eq('org_id',org);
    cache.users=users;
    const tbody=document.querySelector('#tbl-users tbody');
    tbody.innerHTML = users.map(u=>`
      <tr><td>${u.user_id}</td><td>${u.name||''}</td><td>${u.role}</td><td>${(u.perms||[]).join(', ')}</td></tr>
    `).join('') || `<tr><td colspan="4" class="muted">Sin usuarios</td></tr>`;
  }
  $('u-refresh').onclick = renderUsers;
  $('u-guardar').onclick = async ()=>{
    if(!can('usuarios')) return toast('Sin permiso');
    const user_id=$('u-id').value.trim(), name=$('u-name').value.trim(), role=$('u-role').value, perms=($('u-perms').value||'').split(',').map(x=>x.trim()).filter(Boolean);
    if(!user_id||!name) return toast('User ID y nombre');
    const { data:org } = await supabase.from('orgs').select('owner').eq('id',cache.org.id).single();
    const { data:{ user } } = await supabase.auth.getUser();
    if(org.owner!==user.id) return toast('Solo el due√±o de la organizaci√≥n puede editar usuarios');
    const { data:exists } = await supabase.from('profiles').select('user_id').eq('user_id',user_id).maybeSingle();
    if(exists) await supabase.from('profiles').update({ name, role, perms, org_id:cache.org.id }).eq('user_id',user_id);
    else await supabase.from('profiles').insert({ user_id, name, role, perms, org_id:cache.org.id });
    await renderUsers(); toast('Perfil guardado');
  };

  /* ===== Tabs ===== */
  
// --- Mostrar descripci√≥n de envase al lado del c√≥digo ---
function getEnvaseByCodigo(cod){
  if(!cod) return null;
  cod = String(cod).trim().toLowerCase();
  const arr = (cache && cache.envases) ? cache.envases : [];
  return arr.find(e => String(e.codigo).trim().toLowerCase() === cod) || null;
}
function wireEnvaseDescripcion(){
  const inCod  = document.getElementById('p-envase');
  const inDesc = document.getElementById('p-envase-desc');
  if(!inCod || !inDesc) return;
  const update = () => {
    const e = getEnvaseByCodigo(inCod.value);
    inDesc.value = e ? (e.descripcion || e.nombre || '') : '';
  };
  ['input','change','blur'].forEach(ev => inCod.addEventListener(ev, update));
  update();
}
function activateTab(tab){ document.querySelectorAll('section[id^="tab-"]').forEach(s=>s.style.display='none'); document.querySelectorAll('.tab').forEach(b=>b.classList.remove('active')); const btn=document.querySelector(`.tab[data-tab="${tab}"]`); const sec=$('tab-'+tab); if(btn&&sec&&btn.style.display!=='none'){ btn.classList.add('active'); sec.style.display='block'; } }
  $('tabsBar').addEventListener('click',(e)=>{ if(e.target.classList.contains('tab')) activateTab(e.target.dataset.tab); if(e.target.dataset.tab==='pedidos'){ try{ wireEnvaseDescripcion(); }catch(_){} } });

  /* ===== INIT ===== */
  (async ()=>{ const { data:{ session } } = await supabase.auth.getSession(); if(session?.user){ await ensureBootstrap(session.user); await afterAuth(session.user); } else { showLogin(); } })();
  </script>

  <!-- ===== PARCHE: Limpiar sesi√≥n/cookies al cerrar pesta√±a/ventana ===== -->
  <script>
  window.addEventListener("beforeunload", () => {
    try { localStorage.clear(); sessionStorage.clear(); } catch(e){}
    try {
      document.cookie.split(";").forEach(c => {
        document.cookie = c.trim().split("=")[0] + "=;expires=Thu, 01 Jan 1970 00:00:00 UTC;path=/";
      });
    } catch(_) {}
  });

  // Captura global de errores para evitar que la app ‚Äúse congele‚Äù
  window.addEventListener('error', function (e) {
    try { console.error(e.error || e.message); } catch(_) {}
    try { toast('Error: ' + ((e.error && e.error.message) ? e.error.message : e.message)); }
    catch(_) { alert((e.error && e.error.message) ? e.error.message : e.message); }
  });

  window.addEventListener('unhandledrejection', function (e) {
    try { console.error(e.reason); } catch(_) {}
    const msg = (e.reason && e.reason.message) ? e.reason.message : String(e.reason);
    try { toast('Error: ' + msg); } catch(_) { alert(msg); }
  });
  </script>
</body>
</html>
